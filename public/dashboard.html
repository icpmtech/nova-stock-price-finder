<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - NovaMarketHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e'
            }
          },
          animation: {
            'slide-in': 'slideIn 0.3s ease-out',
            'fade-in': 'fadeIn 0.5s ease-out',
            'pulse-soft': 'pulseSoft 2s infinite',
            'bounce-soft': 'bounceSoft 0.6s ease-out',
            'float': 'float 3s ease-in-out infinite'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    :root {
      --primary-50: #f0f9ff;
      --primary-100: #e0f2fe;
      --primary-500: #0ea5e9;
      --primary-600: #0284c7;
      --primary-700: #0369a1;
      --primary-800: #075985;
      --primary-900: #0c4a6e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* COMPONENT STYLES */
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .input-glow {
      transition: box-shadow 0.3s ease;
    }

    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
      outline: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.3);
    }

    .sidebar-gradient {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    }

    .transaction-row {
      transition: all 0.2s ease;
    }

    .transaction-row:hover {
      background: linear-gradient(90deg, #f8fafc 0%, #e2e8f0 100%);
      transform: scale(1.01);
    }

    .operation-buy {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .operation-sell {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulseSoft {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.8;
      }
    }

    @keyframes bounceSoft {

      0%,
      20%,
      50%,
      80%,
      100% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      60% {
        transform: translateY(-5px);
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* MOBILE OFFCANVAS */
    .mobile-sidebar {
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 50;
    }

    .mobile-sidebar.active {
      transform: translateX(0);
    }

    .mobile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 40;
    }

    .mobile-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    @media (min-width: 1024px) {
      .desktop-sidebar {
        transform: none !important;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        z-index: 30;
      }

      .mobile-overlay {
        display: none;
      }

      .desktop-content {
        margin-left: 16rem;
      }
    }

    @media (max-width: 640px) {
      .mobile-card {
        margin: 0.5rem;
        border-radius: 1rem;
      }

      .mobile-form {
        padding: 1rem;
      }

      .mobile-input {
        font-size: 16px;
      }

      .mobile-button {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }
    }

    @media (min-width: 641px) and (max-width:1024px) {
      .tablet-grid {
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }

      .tablet-form {
        grid-column: span 2;
      }

      .tablet-table {
        grid-column: span 2;
      }
    }

    @media (min-width:1025px) {
      .desktop-grid {
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
      }
    }

    .responsive-table {
      max-height: 400px;
      overflow-y: auto;
    }

    .responsive-table::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .responsive-table::-webkit-scrollbar-track {
      background: #f8fafc;
    }

    .responsive-table::-webkit-scrollbar-thumb {
      background: #e2e8f0;
      border-radius: 4px;
    }

    .responsive-table::-webkit-scrollbar-thumb:hover {
      background: #cbd5e1;
    }

    .touch-target {
      min-height: 44px;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .focus-visible:focus {
      outline: 2px solid var(--primary-500);
      outline-offset: 2px;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      padding: 16px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      max-width: 300px;
      animation: slideIn 0.3s ease-out;
    }

    .notification.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .notification.info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #9ca3af;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      color: #d1d5db;
    }
  </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col">
  <div id="header-widget"></div>
  <!-- 2) Include the widget script -->
  <script type="module" src="header.js"></script>
  <div class="flex flex-1 overflow-hidden">
    <!-- SIDEBAR -->
    <aside id="sidebar"
      class="sidebar-gradient w-64 border-r border-gray-200 shadow-xl p-6 flex flex-col mobile-sidebar desktop-sidebar">
      <div class="flex items-center justify-between mb-6 lg:hidden">
        <h2 class="text-xl font-bold text-gray-800">NovaHub</h2>
        <button id="closeSidebarBtn" class="p-2 rounded-lg hover:bg-gray-100 touch-target focus-visible"
          aria-label="Fechar menu">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <h2
        class="hidden lg:block text-2xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-primary-600 to-primary-800">
        NovaHub</h2>
      <nav class="flex-1 space-y-2" role="navigation">
        <a href="#"
          class="flex items-center px-4 py-3 rounded-xl bg-primary-50 text-primary-700 font-medium hover:bg-primary-100 transition focus-visible"
          aria-current="page"><span class="text-xl mr-3">üìä</span>Dashboard</a>
        <a href="#" class="flex items-center px-4 py-3 rounded-xl hover:bg-gray-100 transition focus-visible"><span
            class="text-xl mr-3">üíº</span>Transa√ß√µes</a>
        <a href="#" class="flex items-center px-4 py-3 rounded-xl hover:bg-gray-100 transition focus-visible"><span
            class="text-xl mr-3">üìà</span>Relat√≥rios</a>
        <a href="#" class="flex items-center px-4 py-3 rounded-xl hover:bg-gray-100 transition focus-visible"><span
            class="text-xl mr-3">‚öôÔ∏è</span>Defini√ß√µes</a>
      </nav>
      <button id="signOutBtn"
        class="mt-auto btn-danger text-white py-3 rounded-xl flex items-center justify-center touch-target focus-visible"
        aria-label="Sair"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
        </svg>Sair</button>
    </aside>
    <div id="overlay" class="mobile-overlay lg:hidden" aria-hidden="true"></div>
    <main class="flex-1 overflow-auto p-6 desktop-content">
      <div class="lg:hidden flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
        <button id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-white/20 touch-target focus-visible text-white"
          aria-label="Abrir menu"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg></button>
      </div>

      <section class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover animate-fade-in">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Bem-vindo, <span id="userName"
                class="text-primary-600 animate-pulse-soft">Utilizador</span>!</h2>
            <p class="text-gray-600">Aqui est√° um resumo das suas transa√ß√µes.</p>
          </div>
          <div class="hidden md:block animate-float">
            <div
              class="w-20 h-20 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6 a2 2 0 0 0 -2 -2 H5 a2 2 0 0 0 -2 2 v6 a2 2 0 0 0 2 2 h2 a2 2 0 0 0 2 -2
                         m0 0 V9 a2 2 0 0 1 2 -2 h2 a2 2 0 0 1 2 2 v10
                         m-6 0 a2 2 0 0 0 2 2 h2 a2 2 0 0 0 2 -2
                         m0 0 V5 a2 2 0 0 1 2 -2 h2 a2 2 0 0 1 2 2 v14
                         a2 2 0 0 1 -2 2 h-2 a2 2 0 0 1 -2 -2 z" />
              </svg>
            </div>
          </div>
        </div>
      </section>
      <section class="animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
          <h2 class="text-3xl font-bold flex items-center mb-4 lg:mb-0 text-gray-800"><span
              class="mr-3 text-4xl animate-bounce-soft">üìà</span>Transa√ß√µes de A√ß√µes</h2>
          <div class="hidden md:flex items-center space-x-4 text-gray-500">
            <div class="flex items-center space-x-2"><span
                class="w-3 h-3 bg-green-500 rounded-full"></span><span>Compra</span></div>
            <div class="flex items-center space-x-2"><span
                class="w-3 h-3 bg-red-500 rounded-full"></span><span>Venda</span></div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="bg-white rounded-2xl shadow-xl p-6 card-hover">
            <h3 class="text-xl font-semibold mb-4 flex items-center text-gray-800"><span class="mr-2">‚ú®</span>Nova
              Transa√ß√£o</h3>
            <form id="transactionForm" class="space-y-4">
              <input type="hidden" id="transactionId">
              <div class="space-y-2"><label for="symbol" class="block text-sm font-medium text-gray-700">S√≠mbolo da
                  A√ß√£o</label><input type="text" id="symbol" required
                  class="w-full border border-gray-300 rounded-xl px-4 py-3 input-glow mobile-input"
                  placeholder="Ex: AAPL" autocomplete="off"></div>
              <div class="space-y-2"><label for="operation" class="block text-sm font-medium text-gray-700">Tipo de
                  Opera√ß√£o</label><select id="operation"
                  class="w-full border border-gray-300 rounded-xl px-4 py-3 input-glow">
                  <option value="buy">üü¢ Compra</option>
                  <option value="sell">üî¥ Venda</option>
                </select></div>
              <div class="space-y-2"><label for="amount"
                  class="block text-sm font-medium text-gray-700">Quantidade</label><input type="number" id="amount"
                  min="1" required class="w-full border border-gray-300 rounded-xl px-4 py-3 input-glow mobile-input"
                  placeholder="Ex: 100"></div>
              <div class="space-y-2"><label for="price" class="block text-sm font-medium text-gray-700">Pre√ßo por A√ß√£o
                  (‚Ç¨)</label><input type="number" id="price" step="0.0001" min="0" required
                  class="w-full border border-gray-300 rounded-xl px-4 py-3 input-glow mobile-input"
                  placeholder="Ex: 150.25"></div>
              <div class="space-y-2"><label for="fee" class="block text-sm font-medium text-gray-700">Taxa
                  (‚Ç¨)</label><input type="number" id="fee" step="0.0001" min="0" required
                  class="w-full border border-gray-300 rounded-xl px-4 py-3 input-glow mobile-input"
                  placeholder="Ex: 5.00"></div>
              <div class="space-y-2"><label for="date" class="block text-sm font-medium text-gray-700">Data da
                  Transa√ß√£o</label><input type="date" id="date" required
                  class="w-full border border-gray-300 rounded-xl px-4 py-3 input-glow"></div>
              <button id="submitBtn" type="submit"
                class="w-full btn-primary text-white py-3 rounded-xl flex items-center justify-center space-x-2 mobile-button"><span
                  id="submitText">üíæ Guardar Transa√ß√£o</span><svg id="loadingSpinner"
                  class="hidden w-5 h-5 loading-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg></button>
            </form>
          </div>
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6 card-hover">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold flex items-center text-gray-800"><span class="mr-2">üìã</span>Hist√≥rico de
                Transa√ß√µes</h3>
              <div class="text-gray-500">Total: <span id="totalTransactions"
                  class="font-semibold text-primary-600">0</span></div>
            </div>
            <div class="hidden md:block responsive-table">
              <table class="w-full table-auto">
                <thead class="bg-gray-50 sticky top-0">
                  <tr class="text-left">
                    <th class="px-4 py-3 font-medium text-gray-700">S√≠mbolo</th>
                    <th class="px-4 py-3 font-medium text-gray-700">Opera√ß√£o</th>
                    <th class="px-4 py-3 font-medium text-gray-700">Quantidade</th>
                    <th class="px-4 py-3 font-medium text-gray-700">Pre√ßo (‚Ç¨)</th>
                    <th class="px-4 py-3 font-medium text-gray-700">Taxa (‚Ç¨)</th>
                    <th class="px-4 py-3 font-medium text-gray-700">Data</th>
                    <th class="px-4 py-3 font-medium text-gray-700">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="transactionsBody"></tbody>
              </table>
            </div>
            <div class="md:hidden" id="mobileTransactionsList"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  <footer class="bg-white text-center p-4 text-xs text-gray-500 border-t">
    <div class="flex justify-center items-center space-x-2"><span>¬© 2025 NovaMarketHub</span><span>|</span><span
        class="text-primary-600">Powered by Innovation</span></div>
  </footer>
  <script>
    // State & DOM
    const state = { userEmail: '', transactions: [] };
    const els = {
      mobileMenuBtn: document.getElementById('mobileMenuBtn'),
      closeSidebarBtn: document.getElementById('closeSidebarBtn'),
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('overlay'),
      userName: document.getElementById('userName'),
      signOutBtn: document.getElementById('signOutBtn'),
      form: document.getElementById('transactionForm'),
      transactionId: document.getElementById('transactionId'),
      symbol: document.getElementById('symbol'),
      operation: document.getElementById('operation'),
      amount: document.getElementById('amount'),
      price: document.getElementById('price'),
      fee: document.getElementById('fee'),
      date: document.getElementById('date'),
      submitBtn: document.getElementById('submitBtn'),
      submitText: document.getElementById('submitText'),
      loadingSpinner: document.getElementById('loadingSpinner'),
      tbody: document.getElementById('transactionsBody'),
      mobileList: document.getElementById('mobileTransactionsList'),
      total: document.getElementById('totalTransactions')
    };

    // Utils defaults:
    const fmtDate = s => new Date(s).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white font-medium animate-bounce-soft ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
        }`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
    const notify = showNotification;

    // Mobile menu
    (() => {
      const toggle = () => {
        els.sidebar.classList.toggle('active');
        els.overlay.classList.toggle('active');
        document.body.classList.toggle('overflow-hidden');
      };
      if (els.mobileMenuBtn && els.closeSidebarBtn) {
        els.mobileMenuBtn.addEventListener('click', toggle);
        els.closeSidebarBtn.addEventListener('click', toggle);
        els.overlay.addEventListener('click', toggle);
        window.addEventListener('resize', () => {
          if (window.innerWidth >= 1024) {
            els.sidebar.classList.remove('active');
            els.overlay.classList.remove('active');
            document.body.classList.remove('overflow-hidden');
          }
        });
      }
    })();

    // Auth & Data (Firebase assumed initialized in firebase-init.js)
    import('./firebase-init.js').then(({ auth }) => {
      import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js').then(({ getAuth, onAuthStateChanged, signOut }) => {
        onAuthStateChanged(auth, u => {
          if (!u) return location = '/login.html';
          state.userEmail = u.email;
          els.userName.textContent = u.displayName || u.email.split('@')[0];
          fetchTransactions();
        });
        els.signOutBtn.addEventListener('click', async () => {
          els.signOutBtn.disabled = true;
          await signOut(auth);
          location = '/login.html';
        });
      });
    });
    const getAPI = () => `/api/transactions?user=${encodeURIComponent(state.userEmail)}`;

    // Fetch & render
    tbodyEl = els.tbody;
    async function fetchTransactions() {
      try {
        const res = await fetch(getAPI());
        state.transactions = await res.json();
        render();
      } catch (err) {
        notify('Erro ao carregar transa√ß√µes', 'error');
        console.error(err);
      }
    }

    function render() {
      els.tbody.innerHTML = '';
      els.mobileList.innerHTML = '';
      els.total.textContent = state.transactions.length;

      if (!state.transactions.length) {
        const emptyDesktop = `
      <tr><td colspan="7" class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">\
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6" />\
        </svg>
        <p>Sem transa√ß√µes registadas</p>
      </td></tr>`;
        els.tbody.innerHTML = emptyDesktop;
        els.mobileList.innerHTML = emptyDesktop.replace(/tr|td/g, 'div').replace(/colspan=\"7\"/, '');
        return;
      }

      state.transactions.forEach((t, i) => {
        const opClass = t.operation === 'buy' ? 'operation-buy' : 'operation-sell';
        const opText = t.operation === 'buy' ? 'üü¢ Compra' : 'üî¥ Venda';

        // Desktop row
        const row = document.createElement('tr');
        row.className = 'transaction-row border-b border-gray-100';
        row.style.animationDelay = `${i * 0.1}s`;
        row.innerHTML = `
      <td class="px-4 py-4 font-semibold">${t.symbol}</td>
      <td class="px-4 py-4"><span class="px-3 py-1 rounded-full text-xs text-white ${opClass}">${opText}</span></td>
      <td class="px-4 py-4">${t.amount.toLocaleString()}</td>
      <td class="px-4 py-4">‚Ç¨${t.price.toFixed(4)}</td>
      <td class="px-4 py-4">‚Ç¨${t.fee.toFixed(4)}</td>
      <td class="px-4 py-4">${fmtDate(t.date)}</td>
      <td class="px-4 py-4 flex space-x-2">
        <button data-id="${t.id}" class="del-btn p-2 text-red-600 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
        <button data-t="${encodeURIComponent(JSON.stringify(t))}" class="edit-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg">‚úèÔ∏è</button>
      </td>`;
    els.tbody.appendChild(row);

    // Mobile card
    const card = document.createElement('div');
    card.className = 'mobile-transaction-card transaction-row';
    card.style.animationDelay = `${ i * 0.1 } s`;
    card.innerHTML = `
          < div class="flex justify-between mb-2" >
        <div class="font-semibold">${t.symbol}</div>
        <span class="px-3 py-1 rounded-full text-xs text-white ${opClass}">${opText}</span>
      </div >
      <p>Qtd: ${t.amount.toLocaleString()} | Pre√ßo: ‚Ç¨${t.price.toFixed(4)}</p>
      <p>Taxa: ‚Ç¨${t.fee.toFixed(4)} | Data: ${fmtDate(t.date)}</p>
        `;
    els.mobileList.appendChild(card);
  });
}

// Handlers: edit, delete
els.tbody.addEventListener('click', e => {
  if (e.target.closest('.edit-btn')) {
    const t = JSON.parse(decodeURIComponent(e.target.closest('.edit-btn').dataset.t));
    els.transactionId.value = t.id;
    els.symbol.value = t.symbol;
    els.operation.value = t.operation;
    els.amount.value = t.amount;
    els.price.value = t.price;
    els.fee.value = t.fee;
    els.date.value = t.date;
    els.submitText.textContent = '‚úèÔ∏è Atualizar Transa√ß√£o';
    notify('Transa√ß√£o carregada para edi√ß√£o', 'info');
    if (window.innerWidth < 1024) els.form.scrollIntoView({ behavior: 'smooth' });
  }

  if (e.target.closest('.del-btn')) {
    const id = e.target.closest('.del-btn').dataset.id;
    if (confirm('Tem certeza que deseja eliminar esta transa√ß√£o?')) deleteTransaction(id);
  }
});

async function deleteTransaction(id) {
  try {
   
    await fetch(`${getAPI()}&id=${id}`, { method: 'DELETE' });
    fetchTransactions();
    notify('Transa√ß√£o eliminada com sucesso!', 'success');
  } catch (err) {
    notify('Erro ao eliminar transa√ß√£o.', 'error');
    console.error(err);
  }
}

// Form submit
els.form.addEventListener('submit', async e => {
  e.preventDefault();
  const id = els.transactionId.value;
  const payload = {
    symbol: els.symbol.value.trim(),
    operation: els.operation.value,
    amount: parseFloat(els.amount.value),
    price: parseFloat(els.price.value),
    fee: parseFloat(els.fee.value),
    date: els.date.value
  };
  const errors = [];
  if (!payload.symbol) errors.push('S√≠mbolo obrigat√≥rio');
  if (!payload.operation) errors.push('Opera√ß√£o obrigat√≥ria');
  if (!payload.amount || payload.amount <= 0) errors.push('Quantidade inv√°lida');
  if (!payload.price || payload.price <= 0) errors.push('Pre√ßo inv√°lido');
  if (payload.fee < 0) errors.push('Taxa inv√°lida');
  if (!payload.date) errors.push('Data obrigat√≥ria');
  if (errors.length) return notify(errors.join(', '), 'error');

  els.submitBtn.disabled = true;
  els.loadingSpinner.classList.remove('hidden');
  try {
    const url = new URL(getAPI(), window.location.origin);
url.searchParams.set('id', id);
    await fetch(`${getAPI()}&id=${id}`, {
      method: id ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    notify(id ? 'Transa√ß√£o atualizada com sucesso!' : 'Transa√ß√£o adicionada com sucesso!', 'success');
    els.form.reset();
    els.date.valueAsDate = new Date();
    els.submitText.textContent = 'üíæ Guardar Transa√ß√£o';
    fetchTransactions();
  } catch (err) {
    notify(id ? 'Erro ao atualizar a transa√ß√£o.' : 'Erro ao guardar a transa√ß√£o.', 'error');
    console.error(err);
  } finally {
    els.submitBtn.disabled = false;
    els.loadingSpinner.classList.add('hidden');
  }
});

// Reset on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    els.form.reset();
    els.date.valueAsDate = new Date();
    els.submitText.textContent = 'üíæ Guardar Transa√ß√£o';
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.ctrlKey || e.metaKey) {
    if (e.key === 'n') {
      e.preventDefault();
      els.symbol.focus();
    }
    if (e.key === 'Enter') {
      e.preventDefault();
      els.form.dispatchEvent(new Event('submit'));
    }
  }
});
  </script>
  <script type="module" src="header.js"></script>
</body>

</html>