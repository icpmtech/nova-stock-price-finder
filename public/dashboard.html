<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - novamarketshub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50:  '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e'
            }
          },
          animation: {
            'slide-in':   'slideIn 0.3s ease-out',
            'fade-in':    'fadeIn 0.5s ease-out',
            'pulse-soft': 'pulseSoft 2s infinite',
            'bounce-soft':'bounceSoft 0.6s ease-out',
            'float':      'float 3s ease-in-out infinite'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* Components */
    .card-hover { transition: all .3s cubic-bezier(.4,0,.2,1); }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
    }
    .input-glow:focus { box-shadow: 0 0 0 3px rgba(14,165,233,.3); }
    .btn-primary {
      background: linear-gradient(135deg,#0ea5e9 0%,#0284c7 100%);
      transition: all .3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg,#0284c7 0%,#0369a1 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(14,165,233,.3);
    }
    .btn-danger {
      background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
      transition: all .3s ease;
    }
    .btn-danger:hover {
      background: linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(239,68,68,.3);
    }
    .sidebar-gradient { background: linear-gradient(180deg,#ffffff 0%,#f8fafc 100%); }
    .transaction-row { transition: all .2s ease; }
    .transaction-row:hover {
      background: linear-gradient(90deg,#f8fafc 0%,#e2e8f0 100%);
      transform: scale(1.01);
    }
    .operation-buy {
      background: linear-gradient(135deg,#10b981 0%,#059669 100%);
    }
    .operation-sell {
      background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
    }
    .loading-spinner { animation: spin 1s linear infinite; }

    /* Keyframes */
    @keyframes slideIn { from {transform:translateX(-100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
    @keyframes fadeIn  { from {opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
    @keyframes pulseSoft {0%,100%{opacity:1;}50%{opacity:0.8;}}
    @keyframes bounceSoft{0%,20%,50%,80%,100%{transform:translateY(0);}40%{transform:translateY(-10px);}60%{transform:translateY(-5px);}}
    @keyframes float    {0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);}}

    /* Mobile off-canvas + overlay */
    .mobile-sidebar {
      transform: translateX(-100%);
      transition: transform .3s ease;
    }
    .mobile-sidebar.active {
      transform: translateX(0);
    }
    .mobile-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      opacity: 0; visibility: hidden;
      transition: opacity .3s ease;
    }
    .mobile-overlay.active {
      opacity: 1; visibility: visible;
    }

    /* Force visible on desktop */
    @media (min-width: 1024px) {
      .desktop-sidebar {
        transform: none !important;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
      }
      .mobile-overlay { display: none; }
    }

    /* Responsive grids */
    @media (max-width:640px) {
      .tablet-grid, .desktop-grid { grid-template-columns:1fr; }
      .mobile-form{padding:1rem;}
      .mobile-card{margin:.5rem;border-radius:1rem;}
      .mobile-input{font-size:16px;}
      .mobile-button{padding:.75rem 1rem;font-size:.875rem;}
    }
    @media (min-width:641px) and (max-width:1024px) {
      .tablet-grid{grid-template-columns:1fr 1fr;gap:1.5rem;}
      .tablet-form{grid-column:span 2;}
      .tablet-table{grid-column:span 2;}
    }
    @media (min-width:1025px) {
      .desktop-grid{grid-template-columns:1fr 2fr;gap:2rem;}
    }

    /* Scrollbar */
    .responsive-table::-webkit-scrollbar {height:8px;}
    .responsive-table::-webkit-scrollbar-track{background:#f8fafc;}
    .responsive-table::-webkit-scrollbar-thumb{background:#e2e8f0;}

    /* Touch & focus */
    .touch-target {min-height:44px;min-width:44px;display:flex;align-items:center;justify-content:center;}
    .focus-visible:focus {outline:2px solid #0ea5e9;outline-offset:2px;}
  </style>
</head>
<body class="text-gray-800 min-h-screen flex flex-col">

  <div class="flex flex-1 overflow-hidden">

    <aside id="sidebar"
           class="sidebar-gradient w-64 border-r border-gray-200 shadow-xl p-6 flex flex-col
                  mobile-sidebar desktop-sidebar">
      <div class="flex items-center justify-between mb-6 lg:hidden">
        <h2 class="text-xl font-bold">novaHub</h2>
        <button id="closeSidebarBtn" class="p-2 rounded-lg hover:bg-gray-100 touch-target">‚úï</button>
      </div>
      <h2 class="hidden lg:block text-2xl font-bold mb-6 bg-clip-text text-transparent
                 bg-gradient-to-r from-primary-600 to-primary-800">
        novaHub
      </h2>
      <nav class="flex-1 space-y-2">
        <a href="#" class="flex items-center px-4 py-3 rounded-xl bg-primary-50 text-primary-700 font-medium hover:bg-primary-100 transition">
          <span class="text-xl">üìä</span><span class="ml-2">Dashboard</span>
        </a>
        <a href="#" class="flex items-center px-4 py-3 rounded-xl hover:bg-gray-100 transition">
          <span class="text-xl">üíº</span><span class="ml-2">Transa√ß√µes</span>
        </a>
        <a href="report-transactions.html" class="flex items-center px-4 py-3 rounded-xl hover:bg-gray-100 transition">
          <span class="text-xl">üìà</span><span class="ml-2">Relat√≥rios</span>
        </a>
        <a href="#" class="flex items-center px-4 py-3 rounded-xl hover:bg-gray-100 transition">
          <span class="text-xl">‚öôÔ∏è</span><span class="ml-2">Defini√ß√µes</span>
        </a>
      </nav>
      <button id="signOutBtn" class="mt-auto btn-danger text-white py-3 rounded-xl flex items-center justify-center touch-target">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7"/>
        </svg>
        Sair
      </button>
    </aside>

    <div id="overlay" class="mobile-overlay lg:hidden"></div>

    <main class="flex-1 overflow-auto p-6 desktop-content">

      <div class="lg:hidden flex justify-between items-center mb-4">
        <h1 class="text-xl font-bold">Dashboard</h1>
        <button id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-gray-100 touch-target">‚ò∞</button>
      </div>

      <section id="content" class="bg-white rounded-2xl shadow-xl p-6 mb-8 card-hover animate-fade-in">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold mb-2">
              Bem-vindo, <span id="userName" class="text-primary-600 animate-pulse-soft">Utilizador</span>!
            </h2>
            <p class="text-gray-600">Aqui est√° um resumo das suas atividades mais recentes.</p>
          </div>
          <div class="hidden md:block animate-float">
            <div class="w-20 h-20 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0-002-2zm0 0V9
                         a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2
                         a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2
                         v14a2 2 0-01-2 2h-2a2 2 0-01-2-2z"/>
              </svg>
            </div>
          </div>
        </div>
      </section>

      <section class="animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
          <h2 class="text-3xl font-bold flex items-center mb-4 lg:mb-0">
            <span class="mr-3 text-4xl animate-bounce-soft">üìà</span>Transa√ß√µes de A√ß√µes
          </h2>
          <div class="hidden md:flex items-center space-x-4 text-gray-500">
            <div class="flex items-center space-x-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span><span>Compra</span></div>
            <div class="flex items-center space-x-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span><span>Venda</span></div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 tablet-grid desktop-grid">
          <!-- Form -->
          <div class="bg-white rounded-2xl shadow-xl p-6 card-hover mobile-card mobile-form">
            <h3 class="text-xl font-semibold mb-4 flex items-center"><span class="mr-2">‚ú®</span>Nova Transa√ß√£o</h3>
            <form id="transactionForm" class="space-y-4">
              <input type="hidden" id="transactionId">
              <div>
                <label class="block mb-1">S√≠mbolo da A√ß√£o</label>
                <input id="symbol" required class="w-full border rounded-xl px-4 py-2 input-glow uppercase touch-target">
              </div>
              <div>
                <label class="block mb-1">Tipo de Opera√ß√£o</label>
                <select id="operation" class="w-full border rounded-xl px-4 py-2 input-glow touch-target">
                  <option value="buy">üü¢ Compra</option>
                  <option value="sell">üî¥ Venda</option>
                </select>
              </div>
              <div>
                <label class="block mb-1">Quantidade</label>
                <input type="number" id="amount" min="1" required class="w-full border rounded-xl px-4 py-2 input-glow touch-target">
              </div>
              <div>
                <label class="block mb-1">Pre√ßo por A√ß√£o (‚Ç¨)</label>
                <input type="number" id="price" step="0.0001" min="0" required class="w-full border rounded-xl px-4 py-2 input-glow touch-target">
              </div>
              <div>
                <label class="block mb-1">Taxa (‚Ç¨)</label>
                <input type="number" id="fee" step="0.0001" min="0" required class="w-full border rounded-xl px-4 py-2 input-glow touch-target">
              </div>
              <div>
                <label class="block mb-1">Data da Transa√ß√£o</label>
                <input type="date" id="date" required class="w-full border rounded-xl px-4 py-2 input-glow touch-target">
              </div>
              <button id="submitBtn" type="submit" class="w-full btn-primary text-white py-3 rounded-xl flex items-center justify-center space-x-2 touch-target">
                <span id="submitText">üíæ Guardar Transa√ß√£o</span>
                <svg id="loadingSpinner" class="hidden w-5 h-5 loading-spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
              </button>
            </form>
          </div>

          <!-- Table -->
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl p-6 card-hover mobile-card">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold flex items-center"><span class="mr-2">üìã</span>Hist√≥rico de Transa√ß√µes</h3>
              <div class="text-gray-500">Total: <span id="totalTransactions" class="font-semibold text-primary-600">0</span></div>
            </div>
            <div class="responsive-table overflow-auto max-h-96 custom-scrollbar">
              <table class="w-full table-auto">
                <thead class="bg-gray-50 sticky top-0">
                  <tr class="text-left">
                    <th class="px-4 py-3">S√≠mbolo</th>
                    <th class="px-4 py-3">Opera√ß√£o</th>
                    <th class="px-4 py-3">Quantidade</th>
                    <th class="px-4 py-3">Pre√ßo (‚Ç¨)</th>
                    <th class="px-4 py-3">Taxa (‚Ç¨)</th>
                    <th class="px-4 py-3">Data</th>
                    <th class="px-4 py-3">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="transactionsBody"></tbody>
              </table>
            </div>
            <div class="lg:hidden" id="mobileTransactionsList"></div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <footer class="bg-white text-center p-4 text-xs text-gray-500 border-t">
    <div class="flex justify-center space-x-2">
      <span>¬© 2025 novamarketshub</span><span>|</span><span class="text-primary-600">Powered by Innovation</span>
    </div>
  </footer>

  <!-- Mobile Toggle Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mobileMenuBtn   = document.getElementById('mobileMenuBtn');
      const closeSidebarBtn = document.getElementById('closeSidebarBtn');
      const sidebar         = document.getElementById('sidebar');
      const overlay         = document.getElementById('overlay');
      if (!(mobileMenuBtn && closeSidebarBtn && sidebar && overlay)) return;
      function toggle() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        document.body.classList.toggle('overflow-hidden');
      }
      mobileMenuBtn.addEventListener('click', toggle);
      closeSidebarBtn.addEventListener('click', toggle);
      overlay.addEventListener('click', toggle);
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 1024) {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
          document.body.classList.remove('overflow-hidden');
        }
      });
    });
  </script>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { auth } from './firebase-init.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const contentEl = document.getElementById('content');
    const signOutBtn = document.getElementById('signOutBtn');
    const form = document.getElementById('transactionForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const tbodyEl = document.getElementById('transactionsBody');
    const userNameEl = document.getElementById('userName');
    const totalTransactionsEl = document.getElementById('totalTransactions');
    let currentUserEmail = '';

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = '/login.html';
      } else {
        currentUserEmail = user.email;
        userNameEl.textContent = user.displayName || currentUserEmail.split('@')[0];
        contentEl.classList.remove('opacity-50','pointer-events-none');
        contentEl.classList.add('animate-fade-in');
        fetchTransactions();
      }
    });

    signOutBtn.addEventListener('click', async () => {
      submitBtn.disabled = true;
      submitText.textContent = 'A sair...';
      await signOut(auth);
      window.location.href = '/login.html';
    });

    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('symbol').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());

    function getAPI() {
      const userMail = encodeURIComponent((currentUserEmail||'').trim()||'default');
      return `/api/transactions?user=${userMail}`;
    }

    async function fetchTransactions() {
      try {
        const res = await fetch(getAPI());
        const data = await res.json();
        renderTable(data);
      } catch {
        showNotification('Erro ao carregar transa√ß√µes.','error');
      }
    }

    function renderTable(data) {
      tbodyEl.innerHTML = '';
      totalTransactionsEl.textContent = data.length;
      if (!data.length) {
        tbodyEl.innerHTML = `
          <tr><td colspan="7" class="text-center text-gray-400 py-12">
            <div class="flex flex-col items-center space-y-2">
              <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5 a2 2 0 012-2h5.586a1 1 0 01.707.293 l5.414 5.414a1 1 0 01.293.707V19 a2 2 0 01-2 2z"/>
              </svg>
              <span class="text-lg font-medium">Sem transa√ß√µes registadas</span>
              <span class="text-sm">Adicione a sua primeira transa√ß√£o!</span>
            </div>
          </td></tr>`;
      } else {
        data.forEach((t,i) => {
          const row = document.createElement('tr');
          row.className = 'transaction-row border-b border-gray-100';
          row.style.animationDelay = `${i*0.1}s`;
          const opClass = t.operation==='buy'?'operation-buy':'operation-sell';
          const opText  = t.operation==='buy'?'üü¢ Compra':'üî¥ Venda';
          row.innerHTML = `
            <td class="px-4 py-4 font-semibold">${t.symbol}</td>
            <td class="px-4 py-4"><span class="px-3 py-1 rounded-full text-xs font-medium text-white ${opClass}">${opText}</span></td>
            <td class="px-4 py-4">${t.amount.toLocaleString()}</td>
            <td class="px-4 py-4">‚Ç¨${t.price.toFixed(4)}</td>
            <td class="px-4 py-4">‚Ç¨${t.fee.toFixed(4)}</td>
            <td class="px-4 py-4">${formatDate(t.date)}</td>
            <td class="px-4 py-4 flex space-x-2">
              <button data-t='${encodeURIComponent(JSON.stringify(t))}' class="edit-btn p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0-00-2 2v11a2 2 0-002 2h11 a2 2 0-002-2v-5m-1.414-9.414 a2 2 0 112.828 2.828L11.828 15H9 v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button data-id='${t.id}' class="del-btn p-2 text-red-600 hover:bg-red-50 rounded-lg">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0-0116.138 21H7.862 a2 2 0-01-1.995-1.858L5 7m5 4v6m4-6v6 m1-10V4a1 1 0-00-1-1h-4a1 1 0-00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </td>`;
          tbodyEl.appendChild(row);
        });
      }
      const mobileList = document.getElementById('mobileTransactionsList');
      mobileList.innerHTML = '';
      if (!data.length) {
        mobileList.innerHTML = `<div class="text-center text-gray-400 py-12"><div class="flex flex-col items-center space-y-2"><svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0-01-2-2V5 a2 2 0 012-2h5.586a1 1 0 01.707.293 l5.414 5.414a1 1 0 01.293.707V19 a2 2 0 01-2 2z"/></svg><span class="text-lg font-medium">Sem transa√ß√µes registadas</span><span class="text-sm">Adicione a sua primeira transa√ß√£o!</span></div></div>`;
      } else {
        data.forEach((t,i) => {
          const card = document.createElement('div');
          card.className = 'mobile-table-card transaction-row';
          card.style.animationDelay = `${i*0.1}s`;
          const opClass = t.operation==='buy'?'operation-buy':'operation-sell';
          const opText  = t.operation==='buy'?'üü¢ Compra':'üî¥ Venda';
          card.innerHTML = `<div class="flex justify-between mb-2"><div class="font-semibold">${t.symbol}</div><span class="px-3 py-1 rounded-full text-xs font-medium text-white ${opClass}">${opText}</span></div><div class="grid grid-cols-2 gap-2 text-sm"><div>Qtd: ${t.amount.toLocaleString()}</div><div>Pre√ßo: ‚Ç¨${t.price.toFixed(4)}</div><div>Taxa: ‚Ç¨${t.fee.toFixed(4)}</div><div>Data: ${formatDate(t.date)}</div></div><div class="mt-3 flex justify-end space-x-2"><button data-t='${encodeURIComponent(JSON.stringify(t))}' class="edit-btn p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0-00-2 2v11a2 2 0-002 2h11 a2 2 0-002-2v-5m-1.414-9.414 a2 2 0 112.828 2.828L11.828 15H9 v-2.828l8.586-8.586z"/></svg></button><button data-id='${t.id}' class="del-btn p-2 text-red-600 hover:bg-red-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0-0116.138 21H7.862 a2 2 0-01-1.995-1.858L5 7m5 4v6m4-6v6 m1-10V4a1 1 0-00-1-1h-4a1 1 0-00-1 1v3M4 7h16"/></svg></button></div>`;
        });
      }
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      return d.toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric'});
    }

    function showNotification(msg,type='info'){
      const n=document.createElement('div');
      n.className=`fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-medium ${type==='error'?'bg-red-500':type==='success'?'bg-green-500':'bg-blue-500'} animate-bounce-soft`;
      n.textContent=msg;
      document.body.appendChild(n);
      setTimeout(()=>n.remove(),3000);
    }

    // Edit/Delete handlers
    tbodyEl.addEventListener('click',e=>{
      const editBtn=e.target.closest('.edit-btn');
      const delBtn=e.target.closest('.del-btn');
      if(editBtn){
        const t=JSON.parse(decodeURIComponent(editBtn.dataset.t));
        form.transactionId.value=t.id;
        form.symbol.value=t.symbol;
        form.operation.value=t.operation;
        form.amount.value=t.amount;
        form.price.value=t.price;
        form.fee.value=t.fee;
        form.date.value=t.date;
        submitText.textContent='‚úèÔ∏è Atualizar Transa√ß√£o';
        showNotification('Transa√ß√£o carregada para edi√ß√£o','info');
        if(window.innerWidth<1024)form.scrollIntoView({behavior:'smooth'});
      }
      if(delBtn&&confirm('Tem certeza que deseja eliminar esta transa√ß√£o?')){
        deleteTransaction(delBtn.dataset.id);
      }
    });

    async function deleteTransaction(id){
      try {
        await fetch(`${getAPI()}&id=${id}`,{method:'DELETE'});
        fetchTransactions();
        showNotification('Transa√ß√£o eliminada com sucesso!','success');
      } catch {
        showNotification('Erro ao eliminar transa√ß√£o.','error');
      }
    }

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const id=form.transactionId.value;
      const symbol=form.symbol.value.trim();
      const operation=form.operation.value;
      const amount=parseFloat(form.amount.value);
      const price=parseFloat(form.price.value);
      const fee=parseFloat(form.fee.value);
      const date=form.date.value;
      if(!symbol||!operation||amount<=0||price<=0||fee<0||!date)
        return showNotification('Preencha todos os campos corretamente.','error');

      submitBtn.disabled=true;
      submitText.classList.add('hidden');
      loadingSpinner.classList.remove('hidden');

      const payload={symbol,operation,amount,price,fee,date};
      const method=id?'PUT':'POST';
      const url=id?`${getAPI()}&id=${id}`:getAPI();

      try{
        await fetch(url,{
          method,
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        form.reset();
        document.getElementById('date').valueAsDate=new Date();
        fetchTransactions();
        showNotification(id?'Transa√ß√£o atualizada!':'Transa√ß√£o adicionada!','success');
        submitText.textContent='üíæ Guardar Transa√ß√£o';
      } catch{
        showNotification('Erro ao guardar a transa√ß√£o.','error');
      } finally{
        submitBtn.disabled=false;
        submitText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');
      }
    });

    // Keyboard shortcuts & reset
    document.addEventListener('keydown',e=>{
      if(e.key==='Escape'){
        form.reset();
        document.getElementById('date').valueAsDate=new Date();
        submitText.textContent='üíæ Guardar Transa√ß√£o';
      }
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='n'){
        e.preventDefault();
        document.getElementById('symbol').focus();
      }
      if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });

  </script>
  <script type="module" src="header.js"></script>
</body>
</html>
