<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Análises de Empresas e Cotações</title>

  <!-- Tailwind & Plotly -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Estilos -->
  <style>
    /* animações utilitárias e modo vidro */
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .fade-in{animation:fadeIn .3s ease-out}.pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
    .spin{animation:spin 1s linear infinite}
    .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2)}
    .dark .glass{background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1)}
    .checkbox-custom{appearance:none;width:18px;height:18px;border:2px solid #d1d5db;border-radius:4px;background:#fff;position:relative;cursor:pointer;transition:.2s}
    .checkbox-custom:checked{background:#3b82f6;border-color:#3b82f6}
    .checkbox-custom:checked::after{content:'✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:12px;font-weight:bold}
    .dark .checkbox-custom{background:#374151;border-color:#4b5563}
    .toast{position:fixed;top:20px;right:20px;z-index:1000;transform:translateX(400px);transition:transform .3s ease-out}
    .toast.show{transform:translateX(0)}
  </style>

  <!-- SEO dinâmico -->
  <meta id="metaDescription" name="description" content="Visualize indicadores técnicos e informações de empresas em tempo real">
  <link id="canonicalLink" rel="canonical" href="">
  <meta property="og:type" content="website">
  <meta id="ogTitle"       property="og:title"       content="Análises de Ações">
  <meta id="ogDescription" property="og:description" content="Visualize indicadores técnicos e informações de empresas em tempo real">
  <meta id="ogLocale"      property="og:locale"      content="pt_PT">
  <meta property="og:site_name" content="NovaStocks">
  <meta id="twTitle"       name="twitter:title"       content="Análises de Ações">
  <meta id="twDescription" name="twitter:description" content="Visualize indicadores técnicos e informações de empresas em tempo real">
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-white min-h-screen transition-all duration-300">
  <!-- Cabeçalho partilhado -->
  <div id="header-widget"></div>
  <script type="module" src="header.js"></script>

  <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- HEADER -->
    <div class="glass rounded-2xl p-6 mb-8 shadow-lg">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 w-full">
        <div>
          <h1 id="title" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"></h1>
          <p id="subtitle" class="text-gray-600 dark:text-gray-300 mt-1"></p>
        </div>
        <div class="flex items-center gap-2">
          <select id="langSelect" class="glass px-3 py-2 rounded-xl cursor-pointer text-sm focus:outline-none">
            <option value="pt">🇵🇹 PT</option>
            <option value="en">🇬🇧 EN</option>
          </select>
          <button id="toggleTheme" class="glass px-6 py-3 rounded-xl hover:bg-opacity-20 transition-all duration-200 group">
            <span class="mr-2">🌗</span><span id="themeLabel"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- INPUT -->
    <div class="glass rounded-2xl p-6 mb-8 shadow-lg">
      <h2 id="searchHeader" class="text-xl font-semibold mb-4 flex items-center"></h2>
      <div class="flex flex-col sm:flex-row gap-3 mb-6 relative">
        <div class="flex-1 relative">
          <input list="symbolSuggestions" id="symbolInput" maxlength="10" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-800 focus:border-blue-500 dark:focus:border-blue-400 transition-all duration-200 outline-none text-lg">
          <datalist id="symbolSuggestions"></datalist>
          <div id="symbolValidation" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-green-500 opacity-0 transition-opacity">✓</div>
        </div>
        <div class="flex gap-3">
          <button id="plotBtn" disabled class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-4 rounded-xl transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
            <span id="plotBtnText"></span><span id="plotBtnSpinner" class="hidden"><svg class="spin w-5 h-5 inline ml-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg></span>
          </button>
          <button id="clearBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-4 rounded-xl transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"></button>
        </div>
      </div>

      <!-- TYPES -->
      <h3 id="analysisHeader" class="text-lg font-semibold flex items-center mb-4"></h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- checkbox cards -->
        <template id="tplChk">
          <label class="flex items-center space-x-3 p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-200 cursor-pointer group">
            <input type="checkbox" class="typeChk checkbox-custom">
            <div class="flex-1">
              <div class="lbl font-medium group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors"></div>
              <div class="hint text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
          </label>
        </template>
      </div>
    </div>

    <!-- PROGRESS -->
    <div id="progressContainer" class="hidden mb-8">
      <div class="glass rounded-xl p-4 shadow-lg">
        <div class="flex items-center justify-between mb-2">
          <span id="progressLabel" class="text-sm font-medium"></span>
          <span id="progressText" class="text-sm text-gray-600 dark:text-gray-400">0%</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
          <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-purple-600 h-2 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- RESULTADOS -->
    <div id="result" class="space-y-6"></div>

    <!-- CHART -->
    <div id="chartContainer" class="hidden">
      <div class="glass rounded-2xl p-6 shadow-lg">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <h2 id="chartHeader" class="text-2xl font-semibold flex items-center"></h2>
          <div class="flex gap-3">
            <button id="exportPng" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-lg transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">📷 PNG</button>
            <button id="exportCsv" class="bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white px-4 py-2 rounded-lg transition-all duration-200 font-medium shadow-md hover:shadow-lg transform hover:-translate-y-0.5">📊 CSV</button>
          </div>
        </div>
        <div id="chart" class="rounded-xl shadow-inner bg-white dark:bg-gray-800 min-h-96"></div>
      </div>
    </div>

    <!-- EMPTY -->
    <div id="emptyState" class="text-center py-16">
      <div class="text-6xl mb-4">📊</div>
      <h3 id="emptyTitle" class="text-xl font-semibold text-gray-600 dark:text-gray-300 mb-2"></h3>
      <p id="emptyText" class="text-gray-500 dark:text-gray-400 max-w-md mx-auto"></p>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toastContainer"></div>

<script>
/* ---------- I18N ---------- */
const STRINGS={pt:{title:'Análises de Ações',subtitle:'Visualize indicadores técnicos e informações de empresas',theme:'Tema',searchHeader:'Buscar Ação',placeholder:'Ex: PLTR, AAPL, MSFT...',analyse:'📊 Analisar',clear:'🧹 Limpar',analysisHeader:'Tipos de Análise',labelPerfil:'Perfil',hintPerfil:'Informações da empresa',labelRSI:'RSI',hintRSI:'Força relativa',labelMACD:'MACD',hintMACD:'Convergência/Divergência',labelSMA:'SMA',hintSMA:'Média móvel simples',progress:'Analisando...',chartHeader:'Gráfico de Análise',emptyTitle:'Pronto para começar?',emptyText:'Digite o símbolo de uma ação, selecione os tipos de análise e clique em "Analisar" para visualizar os dados.',invalidSymbol:'Símbolo inválido',selectType:'Selecione pelo menos um tipo',noData:'Nenhum dado encontrado',done:'Análise concluída para',cleaned:'Dados limpos',summary:'Resumo Geral',bullish:'Sinais Bullish',bearish:'Sinais Bearish',total:'Total de sinais',confidence:'Confiança'},en:{title:'Stock Analysis',subtitle:'Visualize technical indicators and company information',theme:'Theme',searchHeader:'Search Stock',placeholder:'Eg: PLTR, AAPL, MSFT...',analyse:'📊 Analyse',clear:'🧹 Clear',analysisHeader:'Analysis Types',labelPerfil:'Profile',hintPerfil:'Company information',labelRSI:'RSI',hintRSI:'Relative strength',labelMACD:'MACD',hintMACD:'Convergence/Divergence',labelSMA:'SMA',hintSMA:'Simple moving average',progress:'Analysing...',chartHeader:'Analysis Chart',emptyTitle:'Ready to start?',emptyText:'Enter a stock symbol, choose analysis types and click "Analyse" to see data.',invalidSymbol:'Invalid symbol',selectType:'Select at least one type',noData:'No data found',done:'Analysis finished for',cleaned:'Data cleared',summary:'Overall Summary',bullish:'Bullish signals',bearish:'Bearish signals',total:'Total signals',confidence:'Confidence'}};
let LANG=localStorage.getItem('lang')||'pt';

function t(k){return STRINGS[LANG][k];}
function setSEO(){const base=`${location.origin}${location.pathname}`;$('#canonicalLink').href=LANG==='pt'?base:`${base}?lang=${LANG}`;document.querySelectorAll('link[rel="alternate"]').forEach(l=>l.remove());Object.keys(STRINGS).forEach(l=>{const el=document.createElement('link');el.rel='alternate';el.hreflang=l;el.href=l==='pt'?base:`${base}?lang=${l}`;document.head.appendChild(el)});const def=document.createElement('link');def.rel='alternate';def.hreflang='x-default';def.href=base;document.head.appendChild(def);}
function translate(){$('#title').textContent=t('title');$('#subtitle').textContent=t('subtitle');$('#themeLabel').textContent=t('theme');$('#searchHeader').innerHTML=`<span class="mr-2">🔍</span>${t('searchHeader')}`;$('#symbolInput').placeholder=t('placeholder');$('#plotBtnText').textContent=t('analyse');$('#clearBtn').textContent=t('clear');$('#analysisHeader').innerHTML=`<span class="mr-2">⚙️</span>${t('analysisHeader')}`;$('#progressLabel').textContent=t('progress');$('#chartHeader').innerHTML=`<span class="mr-2">📈</span>${t('chartHeader')}`;$('#emptyTitle').textContent=t('emptyTitle');$('#emptyText').textContent=t('emptyText');}

/* ---------- Helpers ---------- */
const $=sel=>document.querySelector(sel);
const debounce=(fn,d=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);};};
const validateSymbol=s=>!!s&&s.length<=10&&/^[A-Z0-9]+$/.test(s);

/* ---------- Toast ---------- */
function toast(msg,type='info',ms=3000){const t=document.createElement('div');t.className=`toast glass p-4 rounded-xl shadow-lg max-w-sm ${type==='error'?'border-l-4 border-red-500':type==='success'?'border-l-4 border-green-500':'border-l-4 border-blue-500'}`;t.innerHTML=`<div class="flex items-center"><span class="mr-2">${type==='error'?'❌':type==='success'?'✅':'ℹ️'}</span><span>${msg}</span></div>`;$('#toastContainer').appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300);},ms);}

/* ---------- INIT DOM READY ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  const tplChk=$('#tplChk').content;
  const types=[['perfil','labelPerfil','hintPerfil'],['rsi','labelRSI','hintRSI'],['macd','labelMACD','hintMACD'],['sma','labelSMA','hintSMA']];
  const typesContainer=document.querySelector('.grid');
  types.forEach(([val,lbl,hnt])=>{const n=tplChk.cloneNode(true);const inp=n.querySelector('input');inp.value=val;n.querySelector('.lbl').id=lbl;n.querySelector('.hint').id=hnt;typesContainer.appendChild(n);});
  translate();setSEO();$('#langSelect').value=LANG;

  /* refs */
  const input=$('#symbolInput'),datalist=$('#symbolSuggestions'),plotBtn=$('#plotBtn'),plotText=$('#plotBtnText'),plotSpin=$('#plotBtnSpinner'),clearBtn=$('#clearBtn'),progressC=$('#progressContainer'),progressBar=$('#progressBar'),progressTxt=$('#progressText'),symbolValid=$('#symbolValidation'),result=$('#result'),chart=$('#chart'),chartC=$('#chartContainer'),empty=$('#emptyState');

  /* theme */
  if(localStorage.getItem('theme')==='dark'||(!localStorage.getItem('theme')&&matchMedia('(prefers-color-scheme:dark)').matches))document.body.classList.add('dark');
  $('#toggleTheme').addEventListener('click',()=>{document.body.classList.toggle('dark');localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light');if(series.length)Plotly.relayout(chart,{'font.color':document.body.classList.contains('dark')?'#fff':'#000'});});

  /* lang */
  $('#langSelect').addEventListener('change',e=>{LANG=e.target.value;localStorage.setItem('lang',LANG);translate();setSEO();});

  /* autocomplete */
  const auto=debounce(async q=>{if(q.length<2)return datalist.innerHTML='';try{const r=await fetch(`/api/analises?query=${encodeURIComponent(q)}`);const j=await r.json();datalist.innerHTML=j.slice(0,10).map(o=>`<option value="${o.symbol}">${o.name}</option>`).join('');}catch{datalist.innerHTML='';}},300);

  /* inputs */
  input.addEventListener('input',e=>{const v=e.target.value.toUpperCase().trim();e.target.value=v;const ok=validateSymbol(v);symbolValid.style.opacity=v&&ok?'1':'0';plotBtn.disabled=!ok||!document.querySelectorAll('.typeChk:checked').length||loading;auto(v);});
  input.addEventListener('keypress',e=>{if(e.key==='Enter'&&!plotBtn.disabled)plotBtn.click();});
  document.addEventListener('change',e=>{if(e.target.classList.contains('typeChk'))plotBtn.disabled=!validateSymbol(input.value.trim())||!document.querySelectorAll('.typeChk:checked').length||loading;});

  /* progress helpers */
  let loading=false,series=[];
  function setLoad(on){loading=on;plotBtn.disabled=on;plotText.classList.toggle('hidden',on);plotSpin.classList.toggle('hidden',!on);progressC.classList.toggle('hidden',!on);if(!on)progressBar.style.width='0%';}
  function prog(p){progressBar.style.width=p+'%';progressTxt.textContent=p+'%';}

  /* analyse (single fetch) */
  plotBtn.addEventListener('click',async()=>{
    const S=STRINGS[LANG];const sym=input.value.trim().toUpperCase();
    if(!validateSymbol(sym))return toast(S.invalidSymbol,'error');
    const tipos=[...document.querySelectorAll('.typeChk:checked')].map(i=>i.value);
    if(!tipos.length)return toast(S.selectType,'error');

    setLoad(true);prog(15);result.innerHTML='';chart.innerHTML='';series=[];chartC.classList.add('hidden');empty.classList.add('hidden');

    try{
      const res=await fetch(`/api/analises?symbol=${sym}&tipo=${tipos.join(',')}`);
      if(!res.ok)throw new Error('HTTP '+res.status);
      prog(60);
      const data=await res.json();
      prog(80);

      /* perfil card */
      if(data.results?.perfil){const s=data.results.perfil.summary||{};const card=document.createElement('div');card.className='glass rounded-2xl p-6 shadow-lg fade-in';card.innerHTML=`
        <h2 class="text-2xl font-bold mb-2">${sym} - ${s.sector||''}</h2>
        <p class="text-gray-700 dark:text-gray-300">${s.businessSummary||''}</p>`;result.appendChild(card);}

      /* chart series */
      Object.entries(data.results||{}).forEach(([k,v])=>{
        if(v.chart?.x&&v.chart?.y)series.push({x:v.chart.x,y:v.chart.y,mode:'lines',name:k.toUpperCase(),line:{width:2}});
      });

      /* overall summary */
      if(data.overallSummary){const o=data.overallSummary;const c=o.overallSentiment==='BULLISH'?'text-green-500':o.overallSentiment==='BEARISH'?'text-red-500':'text-yellow-500';const sum=document.createElement('div');sum.className='glass rounded-xl p-4 shadow-lg fade-in';sum.innerHTML=`
        <h3 class="text-lg font-semibold mb-2">📊 ${t('summary')}</h3>
        <p>${t('bullish')}: <strong>${o.signalStrength.bullish}</strong></p>
        <p>${t('bearish')}: <strong>${o.signalStrength.bearish}</strong></p>
        <p>${t('total')}: <strong>${o.signalStrength.total}</strong></p>
        <p>${t('confidence')}: <strong>${o.signalStrength.confidence}%</strong></p>
        <p>${t('theme')}: <span class="${c} font-semibold">${o.overallSentiment}</span></p>`;result.appendChild(sum);}

      /* plot chart */
      if(series.length){chartC.classList.remove('hidden');const dark=document.body.classList.contains('dark');
        Plotly.newPlot(chart,series,{title:{text:`${t('chartHeader')} - ${sym}`,font:{size:20,color:dark?'#fff':'#000'}},
                                     paper_bgcolor:'transparent',plot_bgcolor:'transparent',font:{color:dark?'#fff':'#000'},
                                     margin:{l:60,r:40,t:60,b:60}}, {responsive:true,displayModeBar:true,displaylogo:false});
      }

      prog(100);toast(series.length||result.innerHTML?`${S.done} ${sym}`:S.noData,series.length||result.innerHTML?'success':'error');
    }catch(e){toast(e.message,'error');}finally{setLoad(false);}
  });

  /* clear */
  clearBtn.addEventListener('click',()=>{const S=STRINGS[LANG];input.value='';datalist.innerHTML='';result.innerHTML='';chart.innerHTML='';chartC.classList.add('hidden');series=[];symbolValid.style.opacity='0';plotBtn.disabled=true;document.querySelectorAll('.typeChk').forEach(cb=>cb.checked=false);empty.classList.remove('hidden');toast(S.cleaned,'success');});

  /* export */
  $('#exportPng').addEventListener('click',()=>{if(!series.length)return toast('PNG!','error');Plotly.toImage(chart,{format:'png',height:600,width:1000}).then(u=>{const a=document.createElement('a');a.href=u;a.download=`chart-${Date.now()}.png`;a.click();});});
  $('#exportCsv').addEventListener('click',()=>{if(!series.length)return toast('CSV!','error');const max=Math.max(...series.map(s=>s.x.length));let csv='date';series.forEach(s=>csv+=','+s.name);csv+='\n';for(let i=0;i<max;i++){let r=series[0].x[i]||'';series.forEach(s=>r+=','+(s.y[i]??''));csv+=r+'\n';}const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`data-${Date.now()}.csv`;a.click();URL.revokeObjectURL(url);});

  /* suggestions on load */
  empty.classList.remove('hidden');
});
</script>

  <footer class="bg-black text-center py-12 text-gray-600">
    <div class="space-y-4">
      <p class="text-sm">© 2025 NovaStocks.</p>
      <p class="text-xs text-gray-500">Os dados são fornecidos "como estão" e destinam-se apenas a fins informativos, não para fins comerciais.</p>
    </div>
  </footer>
</body>
</html>
