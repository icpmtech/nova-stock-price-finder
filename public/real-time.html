<!DOCTYPE html><html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Transa√ß√µes</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <!-- Google Font: Chakra Petch -->
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'chakra': ['"Chakra Petch"', 'sans-serif'] },
          colors: { 
            primary: { 
              400: '#38bdf8',
              500: '#0ea5e9', 
              600: '#0284c7',
              700: '#0369a1'
            },
            success: { 500: '#10b981' },
            warning: { 500: '#f59e0b' },
            danger:  { 500: '#ef4444' }
          },
          animation: {
            'fade-in':   'fadeIn 0.3s ease-in-out',
            'slide-up':  'slideUp 0.3s ease-out',
            'pulse-slow':'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn   { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp  { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .loading-spinner    { border: 2px solid #f3f3f3; border-top: 2px solid #0ea5e9; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin     { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .profit-positive    { color: #10b981; }
    .profit-negative    { color: #ef4444; }
    .profit-neutral     { color: #6b7280; }
  </style>
</head>
<body class="font-chakra bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 min-h-screen text-gray-800 antialiased">
  <!-- Header + Auth -->
  <header class="flex items-center justify-between p-4 bg-white bg-opacity-20 backdrop-blur-lg fixed top-0 w-full z-50 border-b border-white border-opacity-20">
    <div class="flex items-center space-x-3">
      <span class="text-3xl animate-pulse-slow">üíº</span>
      <div>
        <span class="text-xl font-semibold text-white">Transa√ß√µes</span>
        <p class="text-sm text-white text-opacity-80">Dashboard de Investimentos</p>
      </div>
    </div>
    <div class="flex items-center space-x-4">
      <div class="text-right">
        <span id="userName" class="text-white font-medium block"></span>
        <span id="connectionStatus" class="text-xs text-white text-opacity-70">Conectado</span>
      </div>
      <button id="signOutBtn" class="px-4 py-2 bg-danger-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium">
        Sair
      </button>
    </div>
  </header>  <!-- Loading Overlay -->  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-gray-600">Carregando...</p>
    </div>
  </div>  <!-- Main Content -->  <main class="pt-24 p-4 max-w-6xl mx-auto">
    <!-- Statistics Cards -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">Total de Transa√ß√µes</h3>
        <p id="totalTransactions" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">Lucro Total</h3>
        <p id="totalProfit" class="text-2xl font-bold">‚Ç¨0.00</p>
      </div>
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">√öltima Atualiza√ß√£o</h3>
        <p id="lastUpdate" class="text-sm font-medium">--</p>
      </div>
      <!-- Tempo desde a √∫ltima actualiza√ß√£o -->
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">Tempo desde atualiza√ß√£o</h3>
        <p id="updateTimer" class="text-2xl font-bold">--</p>
      </div>
    </section><!-- Transaction Form -->
<section class="mb-6 bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-6 border border-white border-opacity-20">
  <h2 class="text-xl font-semibold text-white mb-4">
    <span id="formTitle">Nova Transa√ß√£o</span>
    <button id="cancelEdit" class="ml-4 text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 transition-colors duration-200 hidden">
      Cancelar
    </button>
  </h2>
  <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <input type="hidden" id="transactionId" />
    
    <div class="form-group">
      <label class="block text-white mb-2 font-medium">S√≠mbolo *</label>
      <input id="symbol" type="text" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="Ex: AAPL" required>
    </div>
    
    <div class="form-group">
      <label class="block text-white mb-2 font-medium">Opera√ß√£o *</label>
      <select id="operation" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" required>
        <option value="">Selecione uma opera√ß√£o</option>
        <option value="buy">Compra</option>
        <option value="sell">Venda</option>
      </select>
    </div>
    
    <div class="form-group">
      <label class="block text-white mb-2 font-medium">Quantidade *</label>
      <input id="amount" type="number" min="0" step="0.01" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="0" required>
    </div>
    
    <div class="form-group">
      <label class="block text-white mb-2 font-medium">Pre√ßo (‚Ç¨) *</label>
      <input id="price" type="number" min="0" step="0.0001" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="0.0000" required>
    </div>
    
    <div class="form-group">
      <label class="block text-white mb-2 font-medium">Taxa (‚Ç¨) *</label>
      <input id="fee" type="number" min="0" step="0.0001" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="0.0000" required>
    </div>
    
    <div class="form-group">
      <label class="block text-white mb-2 font-medium">Data *</label>
      <input id="date" type="date" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" required>
    </div>
    
    <div class="md:col-span-2 lg:col-span-3">
      <button id="submitBtn" type="submit" class="w-full md:w-auto px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
        <span id="submitText">Guardar Transa√ß√£o</span>
        <div id="submitSpinner" class="loading-spinner hidden inline-block ml-2"></div>
      </button>
    </div>
  </form>
</section>

<!-- Transactions Table -->
<section class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
  <div class="p-4 bg-primary-500 text-white flex justify-between items-center">
    <h2 class="text-xl font-semibold">Transa√ß√µes</h2>
    <button id="refreshBtn" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors duration-200">
      <span id="refreshText">Atualizar</span>
      <div id="refreshSpinner" class="loading-spinner hidden inline-block ml-2"></div>
    </button>
  </div>
  
  <!-- Desktop Table -->
  <div class="hidden lg:block overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S√≠mbolo</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opera√ß√£o</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo Atual</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lucro</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxa</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="transactionTbody" class="bg-white divide-y divide-gray-200">
        <!-- Transactions will be populated here -->
      </tbody>
    </table>
  </div>
  
  <!-- Mobile Cards -->
  <div id="mobileList" class="lg:hidden p-4 space-y-4">
    <!-- Mobile cards will be populated here -->
  </div>
  
  <!-- Empty State -->
  <div id="emptyState" class="text-center py-12 hidden">
    <div class="text-6xl mb-4">üìä</div>
    <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma transa√ß√£o encontrada</h3>
    <p class="text-gray-500 mb-4">Adicione sua primeira transa√ß√£o para come√ßar a acompanhar seus investimentos.</p>
  </div>
</section>

<!-- Profit Chart -->
<section class="bg-white rounded-lg shadow-lg p-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">An√°lise de Lucros</h2>
  <div id="profitChart" class="w-full h-96"></div>
</section>

  </main>  <!-- Toast Notifications -->  <div id="toastContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>  <!-- Delete Confirmation Modal -->  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-lg font-semibold mb-4">Confirmar Exclus√£o</h3>
      <p class="text-gray-600 mb-6">Tem certeza que deseja excluir esta transa√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="flex justify-end space-x-3">
        <button id="cancelDelete" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors duration-200">
          Cancelar
        </button>
        <button id="confirmDelete" class="px-4 py-2 bg-danger-500 text-white rounded hover:bg-red-600 transition-colors duration-200">
          Excluir
        </button>
      </div>
    </div>
  </div>  <script type="module">
    // Initialize Firebase Authentication
    import('./firebase-init.js').then(({ auth }) => {
      import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js').then(({ onAuthStateChanged, signOut }) => {
        onAuthStateChanged(auth, user => {
          if (!user) {
            window.location.href = '/login.html';
            return;
          }
          
          app.state.userEmail = user.email;
          document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
          
          // Initialize app
          app.init();
        });
        
        document.getElementById('signOutBtn').onclick = async () => {
          try {
            await signOut(auth);
            window.location.href = '/login.html';
          } catch (error) {
            app.showToast('Erro ao sair', 'error');
          }
        };
      });
    }).catch(error => {
      console.error('Error loading Firebase:', error);
      app.showToast('Erro ao carregar autentica√ß√£o', 'error');
    });

    // Main Application
    const app = {
      state: {
        transactions: [],
        userEmail: '',
        isLoading: false,
        isEditing: false,
        editingId: null,
        marketPrices: {},
        lastUpdate: null
      },

      elements: {
        // Form elements
        form: document.getElementById('transactionForm'),
        transactionId: document.getElementById('transactionId'),
        symbol: document.getElementById('symbol'),
        operation: document.getElementById('operation'),
        amount: document.getElementById('amount'),
        price: document.getElementById('price'),
        fee: document.getElementById('fee'),
        date: document.getElementById('date'),
        submitBtn: document.getElementById('submitBtn'),
        submitText: document.getElementById('submitText'),
        submitSpinner: document.getElementById('submitSpinner'),
        formTitle: document.getElementById('formTitle'),
        cancelEdit: document.getElementById('cancelEdit'),
        updateTimer: document.getElementById('updateTimer'),
        // Display elements
        tbody: document.getElementById('transactionTbody'),
        mobileList: document.getElementById('mobileList'),
        emptyState: document.getElementById('emptyState'),
        profitChart: document.getElementById('profitChart'),
        
        // Statistics
        totalTransactions: document.getElementById('totalTransactions'),
        totalProfit: document.getElementById('totalProfit'),
        lastUpdate: document.getElementById('lastUpdate'),
        
        // Controls
        refreshBtn: document.getElementById('refreshBtn'),
        refreshText: document.getElementById('refreshText'),
        refreshSpinner: document.getElementById('refreshSpinner'),
        
        // Modals
        deleteModal: document.getElementById('deleteModal'),
        confirmDelete: document.getElementById('confirmDelete'),
        cancelDelete: document.getElementById('cancelDelete'),
        
        // Other
        loadingOverlay: document.getElementById('loadingOverlay'),
        toastContainer: document.getElementById('toastContainer'),
        connectionStatus: document.getElementById('connectionStatus')
      },

      // Initialize application
      init() {
        this.bindEvents();
        this.setDefaultDate();
        this.fetchTransactions();
        this.startMarketPriceUpdates();
        this.startUpdateTimer();
      },

      // Bind event listeners
      bindEvents() {
        // Form events
        this.elements.form.addEventListener('submit', this.handleSubmit.bind(this));
        this.elements.cancelEdit.addEventListener('click', this.cancelEdit.bind(this));
        
        // Table events
        this.elements.tbody.addEventListener('click', this.handleTableClick.bind(this));
        this.elements.mobileList.addEventListener('click', this.handleMobileClick.bind(this));
        
        // Control events
        this.elements.refreshBtn.addEventListener('click', this.refreshData.bind(this));
        
        // Modal events
        this.elements.cancelDelete.addEventListener('click', this.hideDeleteModal.bind(this));
        this.elements.confirmDelete.addEventListener('click', this.deleteTransaction.bind(this));
        
        // Close modal on outside click
        this.elements.deleteModal.addEventListener('click', (e) => {
          if (e.target === this.elements.deleteModal) {
            this.hideDeleteModal();
          }
        });
      },

      // Set default date to today
      setDefaultDate() {
        const today = new Date().toISOString().split('T')[0];
        this.elements.date.value = today;
      },

      // API helpers
      getAPI() {
        return `/api/transactions?user=${encodeURIComponent(this.state.userEmail)}`;
      },

      getPriceAPI(symbol) {
        return `/api/stocks?symbol=${symbol}`;
      },

      // Show loading overlay
      showLoading() {
        this.elements.loadingOverlay.classList.remove('hidden');
      },

      // Hide loading overlay
      hideLoading() {
        this.elements.loadingOverlay.classList.add('hidden');
      },

      // Show toast notification
      showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `animate-slide-up p-4 rounded-lg text-white font-medium ${
          type === 'success' ? 'bg-success-500' :
          type === 'error'   ? 'bg-danger-500'  :
          type === 'warning' ? 'bg-warning-500' :
                               'bg-primary-500'}`;
        toast.textContent = message;
        
        this.elements.toastContainer.appendChild(toast);
        
        setTimeout(() => {
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), 300);
        }, duration);
      },

      // Update connection status
      updateConnectionStatus(isOnline) {
        this.elements.connectionStatus.textContent = isOnline ? 'Conectado' : 'Offline';
        this.elements.connectionStatus.className = `text-xs ${isOnline ? 'text-white text-opacity-70' : 'text-red-300'}`;
      },
      

      computeProfit(tx, marketPrice) {
        return tx.operation === 'buy'
          ? (marketPrice - tx.price) * tx.amount - tx.fee   // compra
          : (tx.price - marketPrice) * tx.amount - tx.fee; // venda
      },

      startUpdateTimer() {
        setInterval(() => {
          if (!this.state.lastUpdate) return;
          const diff = Math.floor((Date.now() - new Date(this.state.lastUpdate)) / 1000);
          const h = Math.floor(diff / 3600);
          const m = Math.floor((diff % 3600) / 60);
          const s = diff % 60;
          const str = h ? `${h}h ${m}m ${s}s` : m ? `${m}m ${s}s` : `${s}s`;
          this.elements.updateTimer.textContent = str;
        }, 1000);
      },
      
      // Fetch transactions
      async fetchTransactions() {
        try {
          this.state.isLoading = true;
          this.updateConnectionStatus(true);
          
          const response = await fetch(this.getAPI());
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          this.state.transactions = await response.json();
          this.renderTransactions();
          this.updateStatistics();
          
        } catch (error) {
          console.error('Error fetching transactions:', error);
          this.showToast('Erro ao carregar transa√ß√µes', 'error');
          this.updateConnectionStatus(false);
        } finally {
          this.state.isLoading = false;
        }
      },

      // Render transactions
      renderTransactions() {
        const { tbody, mobileList, emptyState } = this.elements;
        tbody.innerHTML = '';
        mobileList.innerHTML = '';
        if (this.state.transactions.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }
        emptyState.classList.add('hidden');
        this.state.transactions.forEach(tx => {
          this.renderDesktopRow(tx);
          this.renderMobileCard(tx);
        });
        this.updateMarketPrices();
      },

      // Render desktop table row
      renderDesktopRow(tx) {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-150';
        const opText  = tx.operation === 'buy' ? 'Compra' : 'Venda';
        const opColor = tx.operation === 'buy' ? 'text-success-500' : 'text-danger-500';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.symbol}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${opColor} bg-opacity-10">${opText}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tx.amount}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç¨${tx.price.toFixed(4)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><span id="market-${tx.id}" class="text-gray-400">Carregando...</span></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm"><span id="profit-${tx.id}" class="font-medium">--</span></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ç¨${tx.fee.toFixed(4)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(tx.date).toLocaleDateString('pt-PT')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
            <button data-action="edit"   data-id="${tx.id}" class="text-primary-600 hover:text-primary-900">Editar</button>
            <button data-action="copy"   data-id="${tx.id}" class="text-warning-500 hover:text-warning-700">Copiar</button>
            <button data-action="delete" data-id="${tx.id}" class="text-danger-600 hover:text-red-900">Excluir</button>
          </td>`;
        this.elements.tbody.appendChild(row);
      },

      // Render mobile card
      renderMobileCard(tx) {
        const card = document.createElement('div');
        card.className = 'bg-white border border-gray-200 rounded-lg p-4 animate-fade-in';
        const opText  = tx.operation === 'buy' ? 'Compra' : 'Venda';
        const opColor = tx.operation === 'buy' ? 'text-success-500' : 'text-danger-500';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">${tx.symbol}</h3>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${opColor} bg-opacity-10">${opText}</span>
            </div>
            <div class="text-right space-x-2">
              <button data-action="edit"   data-id="${tx.id}" class="text-primary-600 hover:text-primary-900 text-sm">Editar</button>
              <button data-action="copy"   data-id="${tx.id}" class="text-warning-500 hover:text-warning-700 text-sm">Copiar</button>
              <button data-action="delete" data-id="${tx.id}" class="text-danger-600 hover:text-red-900 text-sm">Excluir</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><p class="text-gray-500">Quantidade</p><p class="font-medium">${tx.amount}</p></div>
            <div><p class="text-gray-500">Pre√ßo</p><p class="font-medium">‚Ç¨${tx.price.toFixed(4)}</p></div>
            <div><p class="text-gray-500">Pre√ßo Atual</p><p id="market-mobile-${tx.id}" class="font-medium text-gray-400">Carregando...</p></div>
            <div><p class="text-gray-500">Lucro</p><p id="profit-mobile-${tx.id}" class="font-medium">--</p></div>
            <div><p class="text-gray-500">Taxa</p><p class="font-medium">‚Ç¨${tx.fee.toFixed(4)}</p></div>
            <div><p class="text-gray-500">Data</p><p class="font-medium">${new Date(tx.date).toLocaleDateString('pt-PT')}</p></div>
          </div>`;
        this.elements.mobileList.appendChild(card);
      },

      // Update statistics
      updateStatistics() {
        this.elements.totalTransactions.textContent = this.state.transactions.length;
        if (this.state.lastUpdate) this.elements.lastUpdate.textContent = new Date(this.state.lastUpdate).toLocaleString('pt-PT');
      },

      handleTableClick(event) {
        const btn = event.target.closest('[data-action]');
        if (!btn || !this.elements.tbody.contains(btn)) return;
        const action = btn.getAttribute('data-action');
        const id     = btn.getAttribute('data-id');
        if (action === 'edit')   this.editTransaction(id);
        if (action === 'copy')   this.copyTransaction(id);
        if (action === 'delete') this.showDeleteModal(id);
      },

      handleMobileClick(event) {
        const btn = event.target.closest('[data-action]');
        if (!btn || !this.elements.mobileList.contains(btn)) return;
        const action = btn.getAttribute('data-action');
        const id     = btn.getAttribute('data-id');
        if (action === 'edit')   this.editTransaction(id);
        if (action === 'copy')   this.copyTransaction(id);
        if (action === 'delete') this.showDeleteModal(id);
      },

      // Handle form submission
      async handleSubmit(event) {
        event.preventDefault();
        const payload = {
          symbol: this.elements.symbol.value.toUpperCase(),
          operation: this.elements.operation.value,
          amount: parseFloat(this.elements.amount.value),
          price: parseFloat(this.elements.price.value),
          fee: parseFloat(this.elements.fee.value),
          date: this.elements.date.value
        };
        if (!this.validateTransaction(payload)) return;
        try {
          this.setSubmitLoading(true);
          let url = this.getAPI();
          let method = 'POST';
          if (this.state.isEditing && this.state.editingId) {
            url += `&id=${this.state.editingId}`;
            method = 'PUT';
          }
          const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          this.resetForm();
          await this.fetchTransactions();
          this.showToast(this.state.isEditing ? 'Transa√ß√£o atualizada com sucesso' : 'Transa√ß√£o criada com sucesso', 'success');
        } catch (err) {
          console.error('Error saving transaction:', err);
          this.showToast('Erro ao salvar transa√ß√£o', 'error');
        } finally {
          this.setSubmitLoading(false);
        }
      },

      validateTransaction(p) {
        const errs = [];
        if (!p.symbol) errs.push('S√≠mbolo √© obrigat√≥rio');
        if (!p.operation) errs.push('Opera√ß√£o √© obrigat√≥ria');
        if (isNaN(p.amount) || p.amount <= 0) errs.push('Quantidade deve ser maior que zero');
        if (isNaN(p.price)  || p.price  <= 0) errs.push('Pre√ßo deve ser maior que zero');
        if (isNaN(p.fee)   || p.fee   <  0) errs.push('Taxa n√£o pode ser negativa');
        if (!p.date) errs.push('Data √© obrigat√≥ria');
        if (errs.length) { errs.forEach(e => this.showToast(e, 'error')); return false; }
        return true;
      },

      setSubmitLoading(l) {
        this.elements.submitBtn.disabled = l;
        this.elements.submitSpinner.classList.toggle('hidden', !l);
        this.elements.submitText.textContent = l ? 'Salvando...' : 'Guardar Transa√ß√£o';
      },

      resetForm() {
        this.elements.form.reset();
        this.setDefaultDate();
        this.state.isEditing = false;
        this.state.editingId = null;
        this.elements.formTitle.textContent = 'Nova Transa√ß√£o';
        this.elements.cancelEdit.classList.add('hidden');
      },

      editTransaction(id) {
        const tx="";
        const t = this.state.transactions.find(tr => tr.id == id);
        if (!t) return;
        this.state.isEditing = true;
        this.state.editingId = t.id;
        this.elements.formTitle.textContent = 'Editar Transa√ß√£o';
        this.elements.cancelEdit.classList.remove('hidden');
        this.elements.transactionId.value = t.id;
        this.elements.symbol.value = t.symbol;
        this.elements.operation.value = t.operation;
        this.elements.amount.value = t.amount;
        this.elements.price.value = t.price;
        this.elements.fee.value = t.fee;
        this.elements.date.value = new Date(t.date).toISOString().split('T')[0];
      },

      copyTransaction(id) {
        const tx = this.state.transactions.find(tr => tr.id == id);
        if (!tx) return;
        this.state.isEditing = false;     // ensures a new POST
        this.state.editingId = null;
        this.elements.formTitle.textContent = 'Copiar Transa√ß√£o';
        this.elements.cancelEdit.classList.remove('hidden');
        this.elements.transactionId.value = '';
        this.elements.symbol.value = tx.symbol;
        this.elements.operation.value = tx.operation;
        this.elements.amount.value = tx.amount;
        this.elements.price.value = tx.price;
        this.elements.fee.value = tx.fee;
        this.elements.date.value = new Date().toISOString().split('T')[0]; // default to today
        this.elements.symbol.focus();
      },

      cancelEdit() {
        this.resetForm();
      },

      showDeleteModal(id) {
        this.state.editingId = id;
        this.elements.deleteModal.classList.remove('hidden');
      },

      hideDeleteModal() {
        this.elements.deleteModal.classList.add('hidden');
      },

      async deleteTransaction() {
        try {
          await fetch(`${this.getAPI()}&id=${this.state.editingId}`, { method: 'DELETE' });
          this.hideDeleteModal();
          await this.fetchTransactions();
          this.showToast('Transa√ß√£o exclu√≠da com sucesso', 'success');
        } catch (e) {
          console.error(e);
          this.showToast('Erro ao excluir transa√ß√£o', 'error');
        }
      },

      async refreshData() {
        this.elements.refreshBtn.disabled = true;
        this.elements.refreshSpinner.classList.remove('hidden');
        await this.fetchTransactions();
        this.elements.refreshSpinner.classList.add('hidden');
        this.elements.refreshBtn.disabled = false;
      },

      startMarketPriceUpdates() {
        this.updateMarketPrices();
        setInterval(() => this.updateMarketPrices(), 60 * 1000);
      },

      async updateMarketPrices() {
        for (const tx of this.state.transactions) {
          try {
            const res = await fetch(this.getPriceAPI(tx.symbol));
            const data = await res.json();
            const market = data.price;
            this.state.marketPrices[tx.id] = market;
            const profit = this.computeProfit(tx, market);
            const cls = profit > 0 ? 'profit-positive' : profit < 0 ? 'profit-negative' : 'profit-neutral';
            document.getElementById(`profit-${tx.id}`).textContent = `‚Ç¨${profit.toFixed(2)}`;
            document.getElementById(`profit-${tx.id}`).className = cls;
            document.getElementById(`market-${tx.id}`).textContent = `‚Ç¨${market.toFixed(2)}`;
            document.getElementById(`profit-mobile-${tx.id}`).textContent = `‚Ç¨${profit.toFixed(2)}`;
            document.getElementById(`profit-mobile-${tx.id}`).className = cls;
            document.getElementById(`market-mobile-${tx.id}`).textContent = `‚Ç¨${market.toFixed(2)}`;
          } catch (err) {
            console.error('Error updating price for', tx.symbol, err);
          }
        }
        let total = 0;
        for (const tx of this.state.transactions) {
          const m = this.state.marketPrices[tx.id] ?? tx.price;
          total += this.computeProfit(tx, m);
        }
        this.state.totalProfit = total;
        const profitCls = total > 0 ? 'profit-positive' : total < 0 ? 'profit-negative' : 'profit-neutral';
        this.elements.totalProfit.textContent = `‚Ç¨${total.toFixed(2)}`;
        this.elements.totalProfit.className   = `text-2xl font-bold ${profitCls}`;
        this.elements.updateTimer.textContent = '0s';
        this.state.lastUpdate = new Date().toISOString();
        this.updateStatistics();
        this.renderProfitChart();
      },

      renderProfitChart() {
        const labels = this.state.transactions.map(t => new Date(t.date).toLocaleDateString('pt-PT'));
        const profits = this.state.transactions.map(t => {
          const m = this.state.marketPrices[t.id] || t.price;
          return this.computeProfit(t, m);
        });
        Plotly.newPlot(this.elements.profitChart, [{ x: labels, y: profits, type: 'scatter', mode: 'lines+markers' }], { margin: { t: 20 } }, { responsive: true });
      }
    };

    // Kickoff
    document.addEventListener('DOMContentLoaded', () => app.init());
  </script></body>
</html>
