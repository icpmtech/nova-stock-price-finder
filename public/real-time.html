<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Stocks</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <!-- Google Font: Chat Sans (Chakra Petch) -->
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'chat-sans': ['"Chakra Petch"', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          animation: {
            'slide-in': 'slideIn 0.3s ease-out',
          },
        }
      }
    }
  </script>
  <style>
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="font-chat-sans bg-gradient-to-br from-purple-500 to-purple-700 min-h-screen antialiased text-gray-800">
  <!-- Header + User Info + Sign Out -->
  <div id="header-widget"></div>
  <script type="module" src="header.js"></script>
  <header class="flex items-center justify-between p-4 bg-white bg-opacity-20 backdrop-blur-lg fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center space-x-2">
      <span class="text-2xl">📈</span>
      <span class="text-xl font-semibold">Nova Stocks</span>
    </div>
    <nav class="hidden lg:flex space-x-4">
      <a href="index.html" class="text-white hover:text-primary-100">Início</a>
      <a href="zack.html" class="text-white hover:text-primary-100">Análise</a>
      <a href="stocks.html" class="text-white hover:text-primary-100">Minhas Ações</a>
      <a href="real-time.html" class="text-white hover:text-primary-100">Acompanhar</a>
      <a href="https://nova-search-stock.netlify.app/" class="text-white hover:text-primary-100">Simular Estratégia</a>
    </nav>
    <div class="hidden lg:flex items-center space-x-4">
      <span id="userName" class="text-white"></span>
      <button id="signOutBtn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition">Sair</button>
    </div>
    <div class="flex items-center space-x-2 lg:hidden">
      <button id="mobileMenuBtn" class="text-white text-2xl">☰</button>
      <button id="themeToggle" class="text-white p-2 bg-primary-500 rounded-lg hover:bg-primary-600 transition">🌓 Tema</button>
    </div>
  </header>

  <!-- Mobile Menu -->
  <div id="mobileMenu" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40">
    <div class="bg-white w-64 h-full p-4 space-y-4">
      <button id="mobileMenuClose" class="text-2xl">✕</button>
      <a href="index.html" class="block">🏠 Início</a>
      <a href="zack.html" class="block">📊 Análise</a>
      <a href="stocks.html" class="block">💼 Ações</a>
      <a href="real-time.html" class="block">📡 Acompanhar</a>
      <a href="https://nova-search-stock.netlify.app/" class="block">🎯 Simular Estratégia</a>
      <hr class="my-2" />
      <span id="userNameMobile" class="block font-semibold"></span>
      <button id="signOutBtnMobile" class="w-full text-left px-2 py-1 text-red-500 hover:bg-red-100 rounded">Sair</button>
    </div>
  </div>

  <!-- Controles de Watchlist -->
  <div class="mt-24 p-4 flex flex-wrap gap-2 items-center">
    <div class="relative flex-1 max-w-xs">
      <input id="inputSymbol" class="w-full p-2 rounded-lg shadow focus:ring-2 focus:ring-primary-500" placeholder="Pesquisar ticker..." />
      <div id="suggestions" class="absolute top-full left-0 right-0 bg-white shadow rounded-lg mt-1 max-h-48 overflow-y-auto hidden"></div>
    </div>
    <button onclick="addStock()" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition">✨ Adicionar</button>
    <button onclick="exportList()" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition">📤 Exportar</button>
    <input type="file" id="fileInput" accept=".json,.csv" class="hidden" />
    <button onclick="document.getElementById('fileInput').click()" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition">📥 Importar</button>
    <button onclick="refreshAll()" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition">🔄 Atualizar</button>
  </div>

  <!-- Grid de Cards -->
  <div class="p-4 grid gap-4" id="stockGrid"></div>

  <!-- Tabela de Watchlist -->
  <div class="p-4 overflow-x-auto">
    <table id="stockTable" class="min-w-full bg-white rounded-lg overflow-hidden">
      <thead class="bg-primary-500 text-white">
        <tr>
          <th onclick="sortTable(0)" class="px-4 py-2 cursor-pointer">Ticker</th>
          <th onclick="sortTable(1)" class="px-4 py-2 cursor-pointer">Preço</th>
          <th onclick="sortTable(2)" class="px-4 py-2 cursor-pointer">Variação</th>
          <th onclick="sortTable(3)" class="px-4 py-2 cursor-pointer">Volume</th>
          <th onclick="sortTable(4)" class="px-4 py-2 cursor-pointer">Cap. Mercado</th>
        </tr>
      </thead>
      <tbody class="divide-y"></tbody>
    </table>
  </div>

  <!-- Formulário de Transações -->
  <div id="formContainer" class="p-4 bg-white bg-opacity-20 backdrop-blur-lg rounded-lg max-w-3xl mx-auto mt-6">
    <form id="transactionForm" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <input type="hidden" id="transactionId" />
      <div>
        <label class="block mb-1 text-white">Símbolo</label>
        <input id="symbol" class="w-full p-2 rounded-lg" required />
      </div>
      <div>
        <label class="block mb-1 text-white">Operação</label>
        <select id="operation" class="w-full p-2 rounded-lg" required>
          <option value="">Selecione</option>
          <option value="buy">Compra</option>
          <option value="sell">Venda</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 text-white">Quantidade</label>
        <input id="amount" type="number" min="0" step="1" class="w-full p-2 rounded-lg" required />
      </div>
      <div>
        <label class="block mb-1 text-white">Preço (€)</label>
        <input id="price" type="number" min="0" step="0.0001" class="w-full p-2 rounded-lg" required />
      </div>
      <div>
        <label class="block mb-1 text-white">Taxa (€)</label>
        <input id="fee" type="number" min="0" step="0.0001" class="w-full p-2 rounded-lg" required />
      </div>
      <div>
        <label class="block mb-1 text-white">Data</label>
        <input id="date" type="date" class="w-full p-2 rounded-lg" required />
      </div>
      <button id="submitBtn" type="submit" class="col-span-full lg:col-start-3 lg:col-end-4 px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition">
        <span id="submitText">💾 Guardar Transação</span>
        <span id="loadingSpinner" class="hidden ml-2 loading-spinner">⏳</span>
      </button>
    </form>
  </div>

  <!-- Lista de Transações -->
  <div class="p-4 max-w-4xl mx-auto">
    <!-- Desktop -->
    <div class="hidden lg:block">
      <table class="w-full bg-white rounded-lg overflow-hidden">
        <thead class="bg-primary-600 text-white">
          <tr>
            <th class="px-4 py-2">Símbolo</th>
            <th class="px-4 py-2">Op.</th>
            <th class="px-4 py-2">Qtd</th>
            <th class="px-4 py-2">Preço</th>
            <th class="px-4 py-2">Taxa</th>
            <th class="px-4 py-2">Data</th>
            <th class="px-4 py-2">Ações</th>
          </tr>
        </thead>
        <tbody id="transactionTbody" class="divide-y"></tbody>
      </table>
    </div>
    <!-- Mobile -->
    <div id="mobileList" class="lg:hidden space-y-4"></div>
    <div class="mt-2 text-white">Total: <span id="total">0</span></div>
  </div>

  <!-- Notificação -->
  <div id="statusIndicator" class="fixed top-4 right-4 hidden bg-primary-500 text-white px-4 py-2 rounded-lg shadow-lg"></div>

  <!-- Lógica JS Completa -->
  <script type="module">
    import('./firebase-init.js').then(({ auth }) => {
      import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js').then(({ onAuthStateChanged, signOut }) => {
        onAuthStateChanged(auth, user => {
          if (!user) return location.href = '/login.html';
          state.userEmail = user.email;
          document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
          document.getElementById('userNameMobile').textContent = document.getElementById('userName').textContent;
          fetchTransactions();
        });
        const doSignOut = async btnId => {
          const btn = document.getElementById(btnId);
          btn.disabled = true;
          await signOut(auth);
          location.href = '/login.html';
        };
        document.getElementById('signOutBtn').addEventListener('click', () => doSignOut('signOutBtn'));
        document.getElementById('signOutBtnMobile').addEventListener('click', () => doSignOut('signOutBtnMobile'));
      });
    });

    // Watchlist
    const symbols = new Set(JSON.parse(localStorage.getItem('watchlist') || '[]'));
    const grid = document.getElementById('stockGrid');
    const tableBody = document.querySelector('#stockTable tbody');
    const input = document.getElementById('inputSymbol');
    const suggestions = document.getElementById('suggestions');
    const statusIndicator = document.getElementById('statusIndicator');

    function showStatus(message, type='success') {
      statusIndicator.textContent = message;
      statusIndicator.className = `fixed top-4 right-4 bg-primary-500 text-white px-4 py-2 rounded-lg shadow-lg`;
      statusIndicator.classList.remove('hidden');
      setTimeout(() => statusIndicator.classList.add('hidden'), 3000);
    }

    function saveList() {
      localStorage.setItem('watchlist', JSON.stringify([...symbols]));
    }

    function createCard(symbol) {
      const div = document.createElement('div');
      div.className = 'card bg-white rounded-lg p-4 shadow-lg slide-in';
      div.id = `card-${symbol}`;
      div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <span class="text-lg font-semibold">${symbol}</span>
          <button onclick="removeStock('${symbol}')" class="text-red-500 hover:text-red-700">×</button>
        </div>
        <div class="text-2xl" id="price-${symbol}">€--</div>
        <div id="change-${symbol}" class="mt-1">--%</div>`;
      grid.appendChild(div);
    }

    function updateCard(symbol, data) {
      document.getElementById(`price-${symbol}`).textContent = `€${data.price.toFixed(2)}`;
      const c = data.changePercent;
      const el = document.getElementById(`change-${symbol}`);
      el.textContent = `${c >= 0 ? '+' : ''}${c.toFixed(2)}%`;
      el.className = c >= 0 ? 'text-green-600' : 'text-red-600';
    }

    async function fetchStock(sym) {
      try {
        const res = await fetch(`/api/stocks?symbol=${sym}`);
        const data = await res.json();
        if (!data.price) throw new Error();
        updateCard(sym, data);
      } catch {
        showStatus(`Erro ao carregar ${sym}`, 'error');
      }
    }

    function refreshAll() {
      showStatus('Atualizando preços...');
      let done = 0;
      symbols.forEach(sym => {
        fetchStock(sym).finally(() => {
          done++;
          if (done === symbols.size) showStatus('Preços atualizados!');
        });
      });
    }

    function addStock() {
      const sym = input.value.trim().toUpperCase();
      if (!sym) return;
      if (symbols.has(sym)) {
        showStatus(`${sym} já está na lista`, 'error');
      } else {
        symbols.add(sym);
        saveList();
        createCard(sym);
        fetchStock(sym);
        showStatus(`${sym} adicionado!`);
      }
      input.value = '';
      suggestions.classList.add('hidden');
    }

    function removeStock(sym) {
      symbols.delete(sym);
      saveList();
      document.getElementById(`card-${sym}`)?.remove();
      tableBody.querySelector(`#row-${sym}`)?.remove();
      showStatus(`${sym} removido`);
    }

    function sortTable(col) {
      const rows = Array.from(tableBody.rows);
      rows.sort((a,b) => {
        const xa = a.cells[col].textContent.replace(/[€,%]/g,''), xb = b.cells[col].textContent.replace(/[€,%]/g,'');
        return col===0 ? xa.localeCompare(xb) : parseFloat(xb)-parseFloat(xa);
      });
      tableBody.innerHTML = '';
      rows.forEach(r=>tableBody.appendChild(r));
    }

    input.addEventListener('input', async () => {
      const q = input.value.trim();
      if (!q) return void suggestions.classList.add('hidden');
      try {
        const res = await fetch(`/api/stocks?query=${q}`);
        const arr = await res.json();
        suggestions.innerHTML = '';
        arr.forEach(({symbol,name})=>{
          const d=document.createElement('div');
          d.className='p-2 hover:bg-gray-100 cursor-pointer';
          d.textContent=`${symbol} – ${name}`;
          d.onclick=()=>{ input.value=symbol; suggestions.classList.add('hidden'); };
          suggestions.appendChild(d);
        });
        suggestions.classList.remove('hidden');
      } catch {
        suggestions.classList.add('hidden');
      }
    });

    document.addEventListener('click', e=>{
      if (!suggestions.contains(e.target) && e.target!==input) {
        suggestions.classList.add('hidden');
      }
    });

    input.addEventListener('keypress', e=>{
      if (e.key==='Enter') addStock();
    });

    function exportList() {
      const blob=new Blob([JSON.stringify([...symbols],null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`watchlist_${new Date().toISOString().slice(0,10)}.json`;
      a.click(); URL.revokeObjectURL(url);
    }

    document.getElementById('fileInput').addEventListener('change', async e=>{
      const f=e.target.files[0]; if(!f) return;
      try {
        const txt=await f.text();
        const list = f.name.endsWith('.csv')
          ? txt.split(',').map(s=>s.trim().toUpperCase())
          : JSON.parse(txt);
        let added=0;
        list.forEach(sym=>{
          if(!symbols.has(sym)){
            symbols.add(sym);
            createCard(sym);
            fetchStock(sym);
            added++;
          }
        });
        saveList();
        showStatus(`${added} adicionados`);
      } catch {
        showStatus('Erro na importação','error');
      }
    });

    // Inicialização Watchlist
    symbols.forEach(sym=>{createCard(sym); fetchStock(sym);});
    setInterval(refreshAll,30000);

    // Transações
    window.state = { transactions: [] };
    const els = {
      tbody: document.getElementById('transactionTbody'),
      mobileList: document.getElementById('mobileList'),
      total: document.getElementById('total'),
      form: document.getElementById('transactionForm'),
      symbol: document.getElementById('symbol'),
      operation: document.getElementById('operation'),
      amount: document.getElementById('amount'),
      price: document.getElementById('price'),
      fee: document.getElementById('fee'),
      date: document.getElementById('date'),
      submitBtn: document.getElementById('submitBtn'),
      submitText: document.getElementById('submitText'),
      transactionId: document.getElementById('transactionId'),
      loadingSpinner: document.getElementById('loadingSpinner'),
    };

    const getAPI = () => `/api/transactions?user=${encodeURIComponent(state.userEmail)}`;

    async function fetchTransactions() {
      try {
        const res = await fetch(getAPI());
        state.transactions = await res.json();
        render();
      } catch {
        showStatus('Erro ao carregar transações', 'error');
      }
    }

    function render() {
      els.tbody.innerHTML = '';
      els.mobileList.innerHTML = '';
      els.total.textContent = state.transactions.length;
      if (!state.transactions.length) {
        const empty = `<div class="empty-state text-white">Sem transações registadas</div>`;
        els.tbody.innerHTML = empty;
        els.mobileList.innerHTML = empty;
        return;
      }
      state.transactions.forEach(t=>{
        const opClass = t.operation === 'buy' ? 'bg-green-500' : 'bg-red-500';
        const opText = t.operation === 'buy' ? 'Compra' : 'Venda';
        // Desktop
        const row=document.createElement('tr');
        row.innerHTML = `
          <td class="px-4 py-2 font-semibold">${t.symbol}</td>
          <td class="px-4 py-2"><span class="px-2 py-1 rounded-full text-white ${opClass}">${opText}</span></td>
          <td class="px-4 py-2">${t.amount}</td>
          <td class="px-4 py-2">€${t.price.toFixed(4)}</td>
          <td class="px-4 py-2">€${t.fee.toFixed(4)}</td>
          <td class="px-4 py-2">${new Date(t.date).toLocaleDateString()}</td>
          <td class="px-4 py-2 space-x-2">
            <button data-id="${t.id}" class="del-btn text-red-600">Excluir</button>
            <button data-t="${encodeURIComponent(JSON.stringify(t))}" class="edit-btn text-blue-600">Editar</button>
          </td>`;
        els.tbody.appendChild(row);
        // Mobile
        const card=document.createElement('div');
        card.className='mobile-transaction-card bg-white rounded-lg p-4';
        card.innerHTML=`
          <div class="flex justify-between mb-2">
            <span class="font-semibold">${t.symbol}</span>
            <span class="px-2 py-1 rounded ${opClass} text-white">${opText}</span>
          </div>
          <p>Qtd: ${t.amount} | Preço: €${t.price.toFixed(4)}</p>
          <p>Taxa: €${t.fee.toFixed(4)} | Data: ${new Date(t.date).toLocaleDateString()}</p>`;
        els.mobileList.appendChild(card);
      });
    }

    els.tbody.addEventListener('click', e=>{
      const editBtn = e.target.closest('.edit-btn');
      const delBtn  = e.target.closest('.del-btn');
      if(editBtn){
        const t = JSON.parse(decodeURIComponent(editBtn.dataset.t));
        els.transactionId.value = t.id;
        els.symbol.value = t.symbol;
        els.operation.value = t.operation;
        els.amount.value = t.amount;
        els.price.value = t.price;
        els.fee.value = t.fee;
        els.date.value = t.date;
        els.submitText.textContent = '✏️ Atualizar Transação';
        showStatus('Pronto para edição','info');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if(delBtn){
        const id = delBtn.dataset.id;
        if(confirm('Eliminar esta transação?')) deleteTransaction(id);
      }
    });

    async function deleteTransaction(id) {
      try {
        await fetch(`${getAPI()}&id=${id}`, { method: 'DELETE' });
        fetchTransactions();
        showStatus('Transação eliminada','success');
      } catch {
        showStatus('Erro ao eliminar','error');
      }
    }

    els.form.addEventListener('submit', async e=>{
      e.preventDefault();
      const id = els.transactionId.value;
      const p = {
        symbol: els.symbol.value.trim(),
        operation: els.operation.value,
        amount: parseFloat(els.amount.value),
        price: parseFloat(els.price.value),
        fee: parseFloat(els.fee.value),
        date: els.date.value
      };
      const errs=[];
      if(!p.symbol) errs.push('Símbolo');
      if(!p.operation) errs.push('Op.');
      if(!p.amount||p.amount<=0) errs.push('Qtd');
      if(!p.price||p.price<=0) errs.push('Preço');
      if(p.fee<0) errs.push('Taxa');
      if(!p.date) errs.push('Data');
      if(errs.length) return showStatus(`Campos: ${errs.join(', ')}`, 'error');
      els.submitBtn.disabled=true;
      els.loadingSpinner.classList.remove('hidden');
      try {
        await fetch(`${getAPI()}${id?`&id=${id}`:''}`, {
          method: id?'PUT':'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(p)
        });
        showStatus(id?'Atualizado':'Adicionado','success');
        els.form.reset();
        els.date.valueAsDate=new Date();
        els.submitText.textContent='💾 Guardar Transação';
        fetchTransactions();
      } catch {
        showStatus(id?'Erro atualizar':'Erro adicionar','error');
      } finally {
        els.submitBtn.disabled=false;
        els.loadingSpinner.classList.add('hidden');
      }
    });

    // Inicialização
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
    });
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
      document.getElementById('mobileMenu').classList.remove('hidden');
    });
    document.getElementById('mobileMenuClose').addEventListener('click', () => {
      document.getElementById('mobileMenu').classList.add('hidden');
    });

    // Inicia fetch de transações após login
    window.addEventListener('load', () => {
      if (state.userEmail) fetchTransactions();
    });
  </script>
</body>
</html>
