<!DOCTYPE html><html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Transa√ß√µes</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    /* Tailwind customisation */
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { chakra: ['"Chakra Petch"', 'sans-serif'] },
          colors: {
            primary: { 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
            success: { 500: '#10b981' },
            warning: { 500: '#f59e0b' },
            danger:  { 500: '#ef4444' }
          },
          animation: {
            'fade-in':   'fadeIn 0.3s ease-in-out',
            'slide-up':  'slideUp 0.3s ease-out',
            'pulse-slow':'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn  { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes spin    { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);} }
    .loading-spinner   { border: 2px solid #f3f3f3; border-top: 2px solid #0ea5e9; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    .profit-positive   { color: #10b981; }
    .profit-negative   { color: #ef4444; }
    .profit-neutral    { color: #6b7280; }
  </style>
</head>
<body class="font-chakra bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 min-h-screen text-gray-800 antialiased">  <!-- Header -->  <header class="flex items-center justify-between p-4 bg-white bg-opacity-20 backdrop-blur-lg fixed top-0 w-full z-50 border-b border-white border-opacity-20">
    <div class="flex items-center space-x-3">
      <span class="text-3xl animate-pulse-slow">üíº</span>
      <div>
        <span class="text-xl font-semibold text-white">Transa√ß√µes</span>
        <p class="text-sm text-white text-opacity-80">Dashboard de Investimentos</p>
      </div>
    </div>
    <div class="flex items-center space-x-4">
      <div class="text-right">
        <span id="userName" class="text-white font-medium block"></span>
        <span id="connectionStatus" class="text-xs text-white text-opacity-70">Conectado</span>
      </div>
      <button id="signOutBtn" class="px-4 py-2 bg-danger-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium">
        Sair
      </button>
    </div>
  </header>
  <div id="header-widget"></div>
  <script type="module" src="header.js"></script>
  <!-- Loading Overlay -->  <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg text-center">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-gray-600">Carregando...</p>
    </div>
  </div>  <!-- Floating Action Button -->  <button id="openFormBtn" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-primary-500 hover:bg-primary-600 text-white shadow-lg flex items-center justify-center z-40 focus:outline-none">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
  </button>  <!-- Drawer Overlay -->  <div id="drawerOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>  <!-- Transaction Drawer -->  <aside id="formDrawer" class="fixed top-0 right-0 transform translate-x-full w-full sm:w-96 max-w-full h-full bg-white bg-opacity-95 backdrop-blur-lg shadow-xl transition-transform duration-300 z-50 overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h2 id="drawerTitle" class="text-lg font-semibold text-gray-800">Nova Transa√ß√£o</h2>
      <button id="closeFormBtn" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6">
      <form id="transactionForm" class="grid grid-cols-1 gap-4">
        <input type="hidden" id="transactionId" />
        <div>
          <label class="block text-gray-700 mb-1 font-medium">S√≠mbolo *</label>
          <input id="symbol" type="text" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="Ex: AAPL" required>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Opera√ß√£o *</label>
          <select id="operation" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" required>
            <option value="">Selecione uma opera√ß√£o</option>
            <option value="buy">Compra</option>
            <option value="sell">Venda</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Quantidade *</label>
          <input id="amount" type="number" min="0" step="0.01" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="0" required>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Pre√ßo (‚Ç¨) *</label>
          <input id="price" type="number" min="0" step="0.0001" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="0.0000" required>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Taxa (‚Ç¨) *</label>
          <input id="fee" type="number" min="0" step="0.0001" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" placeholder="0.0000" required>
        </div>
        <div>
          <label class="block text-gray-700 mb-1 font-medium">Data *</label>
          <input id="date" type="date" class="w-full p-3 rounded-lg border border-gray-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50 transition-all duration-200" required>
        </div>
        <div class="flex items-center space-x-3 mt-2">
          <button id="submitBtn" type="submit" class="flex-1 px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="submitText">Guardar Transa√ß√£o</span>
            <div id="submitSpinner" class="loading-spinner hidden inline-block ml-2"></div>
          </button>
          <button id="cancelEdit" type="button" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 hidden">Cancelar</button>
        </div>
      </form>
    </div>
  </aside>  <!-- Main Content -->  <main class="pt-24 p-4 max-w-6xl mx-auto">
    <!-- Statistics -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">Total de Transa√ß√µes</h3>
        <p id="totalTransactions" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">Lucro Total</h3>
        <p id="totalProfit" class="text-2xl font-bold">‚Ç¨0.00</p>
      </div>
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">√öltima Atualiza√ß√£o</h3>
        <p id="lastUpdate" class="text-sm font-medium">--</p>
      </div>
      <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg p-4 text-white">
        <h3 class="text-sm font-medium opacity-80">Tempo desde atualiza√ß√£o</h3>
        <p id="updateTimer" class="text-2xl font-bold">--</p>
      </div>
    </section><!-- Transactions Table -->
<section class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
  <div class="p-4 bg-primary-500 text-white flex justify-between items-center">
    <h2 class="text-xl font-semibold">Transa√ß√µes</h2>
    <button id="refreshBtn" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors duration-200">
      <span id="refreshText">Atualizar</span>
      <div id="refreshSpinner" class="loading-spinner hidden inline-block ml-2"></div>
    </button>
  </div>
  <div class="hidden lg:block overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S√≠mbolo</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opera√ß√£o</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo Atual</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lucro</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taxa</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="transactionTbody" class="bg-white divide-y divide-gray-200"></tbody>
    </table>
  </div>
  <div id="mobileList" class="lg:hidden p-4 space-y-4"></div>
  <div id="emptyState" class="text-center py-12 hidden">
    <div class="text-6xl mb-4">üìä</div>
    <h3 class="text-xl font-semibold text-gray-700 mb-2">Nenhuma transa√ß√£o encontrada</h3>
    <p class="text-gray-500 mb-4">Adicione sua primeira transa√ß√£o para come√ßar a acompanhar seus investimentos.</p>
  </div>
</section>

<!-- Profit Chart -->
<section class="bg-white rounded-lg shadow-lg p-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">An√°lise de Lucros</h2>
  <div id="profitChart" class="w-full h-96"></div>
</section>

  </main>  <!-- Toast Container -->  <div id="toastContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>  <!-- Delete Confirmation Modal -->  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-lg font-semibold mb-4">Confirmar Exclus√£o</h3>
      <p class="text-gray-600 mb-6">Tem certeza que deseja excluir esta transa√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="flex justify-end space-x-3">
        <button id="cancelDelete" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors duration-200">Cancelar</button>
        <button id="confirmDelete" class="px-4 py-2 bg-danger-500 text-white rounded hover:bg-red-600 transition-colors duration-200">Excluir</button>
      </div>
    </div>
  </div>  <script type="module">
    import('./firebase-init.js').then(({ auth }) => {
      import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js').then(({ onAuthStateChanged, signOut }) => {
        onAuthStateChanged(auth, user => {
          if (!user) {
            window.location.href = '/login.html';
            return;
          }
          app.state.userEmail = user.email;
          document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
          app.init(); // <-- inicializa APENAS depois da autentica√ß√£o
        });
        document.getElementById('signOutBtn').onclick = async () => {
          try {
            await signOut(auth);
            window.location.href = '/login.html';
          } catch {
            app.showToast('Erro ao sair', 'error');
          }
        };
      });
    }).catch(e => {
      console.error(e);
      app.showToast('Erro ao carregar autentica√ß√£o', 'error');
    });

    const app = {
      state: { transactions: [], userEmail: '', marketPrices: {}, lastUpdate: null, deleteId: null },
      _eventsBound: false, // garante que bindEvents corre s√≥ uma vez
      elements: {
        openFormBtn:     document.getElementById('openFormBtn'),
        closeFormBtn:    document.getElementById('closeFormBtn'),
        drawer:          document.getElementById('formDrawer'),
        drawerOverlay:   document.getElementById('drawerOverlay'),
        drawerTitle:     document.getElementById('drawerTitle'),
        form:            document.getElementById('transactionForm'),
        transactionId:   document.getElementById('transactionId'),
        symbol:          document.getElementById('symbol'),
        operation:       document.getElementById('operation'),
        amount:          document.getElementById('amount'),
        price:           document.getElementById('price'),
        fee:             document.getElementById('fee'),
        date:            document.getElementById('date'),
        submitBtn:       document.getElementById('submitBtn'),
        submitText:      document.getElementById('submitText'),
        submitSpinner:   document.getElementById('submitSpinner'),
        cancelEdit:      document.getElementById('cancelEdit'),
        tbody:           document.getElementById('transactionTbody'),
        mobileList:      document.getElementById('mobileList'),
        emptyState:      document.getElementById('emptyState'),
        totalTransactions: document.getElementById('totalTransactions'),
        totalProfit:       document.getElementById('totalProfit'),
        lastUpdateEl:      document.getElementById('lastUpdate'),
        updateTimer:       document.getElementById('updateTimer'),
        refreshBtn:        document.getElementById('refreshBtn'),
        refreshSpinner:    document.getElementById('refreshSpinner'),
        toastContainer:    document.getElementById('toastContainer'),
        deleteModal:       document.getElementById('deleteModal'),
        confirmDelete:     document.getElementById('confirmDelete'),
        cancelDelete:      document.getElementById('cancelDelete'),
        connectionStatus:  document.getElementById('connectionStatus'),
        profitChart:       document.getElementById('profitChart')
      },

      init() {
        if (!this._eventsBound) this.bindEvents();
        this._eventsBound = true;
        this.elements.date.value = new Date().toISOString().split('T')[0];
        this.fetchTransactions();
        this.startPriceUpdater();
        this.startUpdateTimer();
      },

      bindEvents() {
        this.elements.openFormBtn.addEventListener('click', () => this.openDrawer());
        this.elements.closeFormBtn.addEventListener('click', () => this.closeDrawer());
        this.elements.drawerOverlay.addEventListener('click', () => this.closeDrawer());
        this.elements.form.addEventListener('submit', e => this.handleSubmit(e));
        this.elements.cancelEdit.addEventListener('click', () => { this.resetForm(); this.closeDrawer(); });
        this.elements.tbody.addEventListener('click', e => this.handleTableClick(e));
        this.elements.mobileList.addEventListener('click', e => this.handleTableClick(e));
        this.elements.refreshBtn.addEventListener('click', () => this.fetchTransactions());
        this.elements.cancelDelete.addEventListener('click', () => this.hideDeleteModal());
        this.elements.confirmDelete.addEventListener('click', () => this.deleteTransaction());
      },

      openDrawer() {
        this.elements.drawer.classList.remove('translate-x-full');
        this.elements.drawerOverlay.classList.remove('hidden');
      },
      closeDrawer() {
        this.elements.drawer.classList.add('translate-x-full');
        this.elements.drawerOverlay.classList.add('hidden');
      },

      getAPI() {
        return `/api/transactions?user=${encodeURIComponent(this.state.userEmail)}`;
      },
      getPriceAPI(sym) {
        return `/api/stocks?symbol=${sym}`;
      },

      showToast(msg, type = 'info', dur = 3000) {
        const div = document.createElement('div');
        div.className = `animate-slide-up p-4 rounded-lg text-white font-medium ${
          type==='success'? 'bg-success-500' :
          type==='error'?   'bg-danger-500'  :
          type==='warning'? 'bg-warning-500':'bg-primary-500'}`;
        div.textContent = msg;
        this.elements.toastContainer.appendChild(div);
        setTimeout(()=>{
          div.style.opacity='0';
          setTimeout(()=>div.remove(),300);
        }, dur);
      },

      async fetchTransactions() {
        try {
          this.updateConnectionStatus(true);
          const res = await fetch(this.getAPI());
          if(!res.ok) throw new Error(res.statusText);
          this.state.transactions = await res.json();
          this.renderTransactions();
          this.updateStats();
        } catch(e) {
          console.error(e);
          this.showToast('Erro ao carregar transa√ß√µes','error');
          this.updateConnectionStatus(false);
        }
      },

      renderTransactions() {
        this.elements.tbody.innerHTML='';
        this.elements.mobileList.innerHTML='';
        if(!this.state.transactions.length) {
          this.elements.emptyState.classList.remove('hidden');
          return;
        }
        this.elements.emptyState.classList.add('hidden');
        this.state.transactions.forEach(tx=>{
          this.renderDesktopRow(tx);
          this.renderMobileCard(tx);
        });
        this.updateAllPrices();
      },

      renderDesktopRow(tx) {
        const opText = tx.operation==='buy'?'Compra':'Venda';
        const opCol  = tx.operation==='buy'?'text-success-500':'text-danger-500';
        const tr = document.createElement('tr');
        tr.className='hover:bg-gray-50 transition-colors duration-150';
        tr.innerHTML=`
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tx.symbol}</td>
          <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${opCol} bg-opacity-10">${opText}</span></td>
          <td class="px-6 py-4 text-sm text-gray-900">${tx.amount}</td>
          <td class="px-6 py-4 text-sm text-gray-900">‚Ç¨${tx.price.toFixed(4)}</td>
          <td class="px-6 py-4 text-sm text-gray-900"><span id="market-${tx.id}" class="text-gray-400">Carregando...</span></td>
          <td class="px-6 py-4 text-sm"><span id="profit-${tx.id}" class="font-medium">--</span></td>
          <td class="px-6 py-4 text-sm text-gray-900">‚Ç¨${tx.fee.toFixed(4)}</td>
          <td class="px-6 py-4 text-sm text-gray-900">${new Date(tx.date).toLocaleDateString('pt-PT')}</td>
          <td class="px-6 py-4 text-sm font-medium space-x-3">
            <button data-action="edit" data-id="${tx.id}" class="text-primary-600 hover:text-primary-900">Editar</button>
            <button data-action="copy" data-id="${tx.id}" class="text-warning-500 hover:text-warning-700">Copiar</button>
            <button data-action="delete" data-id="${tx.id}" class="text-danger-600 hover:text-red-900">Excluir</button>
          </td>`;
        this.elements.tbody.appendChild(tr);
      },

      renderMobileCard(tx) {
        const opText = tx.operation==='buy'?'Compra':'Venda';
        const opCol  = tx.operation==='buy'?'text-success-500':'text-danger-500';
        const div = document.createElement('div');
        div.className='bg-white border border-gray-200 rounded-lg p-4 animate-fade-in';
        div.innerHTML=`
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="text-lg font-semibold text-gray-900">${tx.symbol}</h3>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${opCol} bg-opacity-10">${opText}</span>
            </div>
            <div class="text-right space-x-2">
              <button data-action="edit" data-id="${tx.id}" class="text-primary-600 hover:text-primary-900 text-sm">Editar</button>
              <button data-action="copy" data-id="${tx.id}" class="text-warning-500 hover:text-warning-700 text-sm">Copiar</button>
              <button data-action="delete" data-id="${tx.id}" class="text-danger-600 hover:text-red-900 text-sm">Excluir</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><p class="text-gray-500">Quantidade</p><p class="font-medium">${tx.amount}</p></div>
            <div><p class="text-gray-500">Pre√ßo</p><p class="font-medium">‚Ç¨${tx.price.toFixed(4)}</p></div>
            <div><p class="text-gray-500">Pre√ßo Atual</p><p id="market-mobile-${tx.id}" class="font-medium text-gray-400">Carregando...</p></div>
            <div><p class="text-gray-500">Lucro</p><p id="profit-mobile-${tx.id}" class="font-medium">--</p></div>
            <div><p class="text-gray-500">Taxa</p><p class="font-medium">‚Ç¨${tx.fee.toFixed(4)}</p></div>
            <div><p class="text-gray-500">Data</p><p class="font-medium">${new Date(tx.date).toLocaleDateString('pt-PT')}</p></div>
          </div>`;
        this.elements.mobileList.appendChild(div);
      },

      updateStats() {
        this.elements.totalTransactions.textContent = this.state.transactions.length;
        if (this.state.lastUpdate) {
          this.elements.lastUpdateEl.textContent = new Date(this.state.lastUpdate).toLocaleString('pt-PT');
        }
      },

      handleTableClick(e) {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action'), id = btn.getAttribute('data-id');
        if (action === 'edit') this.populateForm(id, 'Editar Transa√ß√£o');
        if (action === 'copy') this.populateForm(id, 'Copiar Transa√ß√£o', true);
        if (action === 'delete') this.showDeleteModal(id);
      },

      populateForm(id, title, isCopy = false) {
        const tx = this.state.transactions.find(t => t.id == id);
        if (!tx) return;
        this.elements.drawerTitle.textContent = title;
        this.elements.cancelEdit.classList.remove('hidden');
        this.elements.transactionId.value = isCopy ? '' : tx.id;
        this.elements.symbol.value = tx.symbol;
        this.elements.operation.value = tx.operation;
        this.elements.amount.value = tx.amount;
        this.elements.price.value = tx.price;
        this.elements.fee.value = tx.fee;
        this.elements.date.value = isCopy
          ? new Date().toISOString().split('T')[0]
          : new Date(tx.date).toISOString().split('T')[0];
        this.openDrawer();
      },

      validate(tx) {
        const errs = [];
        if (!tx.symbol) errs.push('S√≠mbolo √© obrigat√≥rio');
        if (!tx.operation) errs.push('Opera√ß√£o √© obrigat√≥ria');
        if (isNaN(tx.amount) || tx.amount <= 0) errs.push('Quantidade deve ser maior que zero');
        if (isNaN(tx.price)  || tx.price <= 0)  errs.push('Pre√ßo deve ser maior que zero');
        if (isNaN(tx.fee)    || tx.fee < 0)    errs.push('Taxa n√£o pode ser negativa');
        if (!tx.date) errs.push('Data √© obrigat√≥ria');
        if (errs.length) { errs.forEach(e=>this.showToast(e,'error')); return false; }
        return true;
      },

      setLoading(btnEl, spinnerEl, isLoading) {
        btnEl.disabled = isLoading;
        spinnerEl.classList.toggle('hidden', !isLoading);
      },

      resetForm() {
        this.elements.form.reset();
        this.elements.date.value = new Date().toISOString().split('T')[0];
        this.elements.cancelEdit.classList.add('hidden');
        this.elements.drawerTitle.textContent = 'Nova Transa√ß√£o';
      },

      async handleSubmit(e) {
        e.preventDefault();
        const id = this.elements.transactionId.value;
        const payload = {
          symbol: this.elements.symbol.value.toUpperCase(),
          operation: this.elements.operation.value,
          amount: parseFloat(this.elements.amount.value),
          price: parseFloat(this.elements.price.value),
          fee:   parseFloat(this.elements.fee.value),
          date:  this.elements.date.value
        };
        if (!this.validate(payload)) return;

        const isEdit = Boolean(id);
        let url = this.getAPI(), method = 'POST';
        if (isEdit) {
          url += `&id=${id}`; method = 'PUT';
        }

        try {
          this.setLoading(this.elements.submitBtn, this.elements.submitSpinner, true);
          const res = await fetch(url, {
            method,
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(res.statusText);

          this.resetForm();
          this.closeDrawer();
          await this.fetchTransactions();
          this.showToast(isEdit?'Atualizado com sucesso':'Criado com sucesso','success');
        } catch(err) {
          console.error(err);
          this.showToast('Erro ao salvar','error');
        } finally {
          this.setLoading(this.elements.submitBtn, this.elements.submitSpinner, false);
        }
      },

      showDeleteModal(id) {
        this.state.deleteId = id;
        this.elements.deleteModal.classList.remove('hidden');
      },
      hideDeleteModal() {
        this.elements.deleteModal.classList.add('hidden');
      },

      async deleteTransaction() {
        try {
          await fetch(`${this.getAPI()}&id=${this.state.deleteId}`,{method:'DELETE'});
          this.hideDeleteModal();
          await this.fetchTransactions();
          this.showToast('Exclu√≠do com sucesso','success');
        } catch(e) {
          console.error(e);
          this.showToast('Erro ao excluir','error');
        }
      },

      async startPriceUpdater() {
        await this.updateAllPrices();
        setInterval(()=>this.updateAllPrices(),60000);
      },

      async updateAllPrices() {
        for (const tx of this.state.transactions) {
          try {
            const res = await fetch(this.getPriceAPI(tx.symbol));
            const { price: market } = await res.json();
            this.state.marketPrices[tx.id] = market;
            this.updateRowProfit(tx, market);
          } catch(e) {
            console.error('Erro pre√ßo',e);
          }
        }
        this.recalculateTotals();
      },

      updateRowProfit(tx, market) {
        const profit = this.computeProfit(tx, market);
        const cls = profit>0?'profit-positive': profit<0?'profit-negative':'profit-neutral';
        document.getElementById(`market-${tx.id}`).textContent = `‚Ç¨${market.toFixed(2)}`;
        document.getElementById(`profit-${tx.id}`).textContent = `‚Ç¨${profit.toFixed(2)}`;
        document.getElementById(`profit-${tx.id}`).className = cls;
        document.getElementById(`market-mobile-${tx.id}`).textContent = `‚Ç¨${market.toFixed(2)}`;
        document.getElementById(`profit-mobile-${tx.id}`).textContent = `‚Ç¨${profit.toFixed(2)}`;
        document.getElementById(`profit-mobile-${tx.id}`).className = cls;
      },

      recalculateTotals() {
        let total = 0;
        this.state.transactions.forEach(tx => {
          const m = this.state.marketPrices[tx.id] ?? tx.price;
          total += this.computeProfit(tx, m);
        });
        this.state.lastUpdate = new Date().toISOString();
        this.elements.totalProfit.textContent = `‚Ç¨${total.toFixed(2)}`;
        this.elements.totalProfit.className = `text-2xl font-bold ${
          total>0?'profit-positive': total<0?'profit-negative':'profit-neutral'}`;
        this.updateStats();
        this.renderChart();
      },

      computeProfit(tx, m) {
        return tx.operation==='buy'
          ? (m - tx.price)*tx.amount - tx.fee
          : (tx.price - m)*tx.amount - tx.fee;
      },

      renderChart() {
        const labels = this.state.transactions.map(t=>new Date(t.date).toLocaleDateString('pt-PT'));
        const data   = this.state.transactions.map(t=>this.computeProfit(t, this.state.marketPrices[t.id]||t.price));
        Plotly.newPlot(this.elements.profitChart, [{ x: labels, y: data, type:'scatter', mode:'lines+markers' }],{margin:{t:20}},{responsive:true});
      },

      updateConnectionStatus(online) {
        this.elements.connectionStatus.textContent = online?'Conectado':'Offline';
        this.elements.connectionStatus.className = `text-xs ${online?'text-white text-opacity-70':'text-red-300'}`;
      },

      startUpdateTimer() {
        setInterval(()=>{
          if(!this.state.lastUpdate) return;
          const diff = Math.floor((Date.now()-new Date(this.state.lastUpdate))/1000);
          const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60), s = diff%60;
          this.elements.updateTimer.textContent =
            h ? `${h}h ${m}m ${s}s` :
            m ? `${m}m ${s}s` :
                `${s}s`;
        },1000);
      }
    };
  </script></body>
</html>
