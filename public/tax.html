<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C√°lculo de Impostos - Wallet360</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jQuery & DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
  <!-- SheetJS for import -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <div class="max-w-4xl mx-auto py-16 px-4">
    <h1 class="text-3xl font-bold text-center mb-8">C√°lculo de Impostos - Wallet360</h1>

    <div class="bg-indigo-100 p-6 rounded-lg shadow mb-6">
      <!-- Import IRS table -->
      <div class="mb-6">
        <label class="block mb-1 font-medium">Importar Tabela IRS (XLSX/CSV)</label>
        <input id="irsFileInput" type="file" accept=".xlsx,.csv" class="w-full p-2 rounded border border-gray-300" />
      </div>
      <!-- Deductions -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Dedu√ß√µes Fiscais (‚Ç¨)</h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <div><label class="block mb-1">Sa√∫de</label><input id="dedSaude" type="number" value="0" class="w-full p-2 rounded border border-gray-300" /></div>
          <div><label class="block mb-1">Educa√ß√£o</label><input id="dedEduc" type="number" value="0" class="w-full p-2 rounded border border-gray-300" /></div>
          <div><label class="block mb-1">Habita√ß√£o</label><input id="dedHabit" type="number" value="0" class="w-full p-2 rounded border border-gray-300" /></div>
          <div><label class="block mb-1">PPR</label><input id="dedPPR" type="number" value="0" class="w-full p-2 rounded border border-gray-300" /></div>
          <div><label class="block mb-1">Donativos</label><input id="dedDon" type="number" value="0" class="w-full p-2 rounded border border-gray-300" /></div>
        </div>
      </div>
      <!-- Settings -->
      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div><label class="block mb-1 font-medium">Data de In√≠cio</label><input id="startDate" type="date" class="w-full p-2 rounded border border-gray-300" /></div>
        <div><label class="block mb-1 font-medium">Data de Fim</label><input id="endDate" type="date" class="w-full p-2 rounded border border-gray-300" /></div>
        <div><label class="block mb-1 font-medium">Taxa IVA (%)</label><input id="ivaRate" type="number" value="23" class="w-full p-2 rounded border border-gray-300" /></div>
        <div>
          <label class="block mb-1 font-medium">Categoria IRS</label>
          <select id="irsCategory" class="w-full p-2 rounded border border-gray-300">
            <option value="A">Categoria A (Trabalho Dependente)</option>
            <option value="B">Categoria B (Trabalho Independente)</option>
            <option value="E">Categoria E (Rendimentos de Capitais)</option>
            <option value="F">Categoria F (Rendimentos Prediais)</option>
            <option value="G">Categoria G (Pens√µes)</option>
            <option value="H">Categoria H (Mais-valias)</option>
          </select>
        </div>
      </div>
      <div class="flex flex-wrap gap-4">
        <button id="btnCalcular" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-3 rounded-lg transition">Calcular Impostos</button>
        <button id="btnExportCSV" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition">Exportar CSV</button>
        <button id="btnExportPDF" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg transition">Exportar PDF</button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="flex items-center justify-center space-x-2 hidden">
      <svg class="animate-spin h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg>
      <span class="text-indigo-600 font-medium">A processar, por favor aguarde...</span>
    </div>

    <!-- Results -->
    <div id="resultado" class="mt-8 hidden"></div>
    <!-- Tables -->
    <div id="tabelas" class="mt-12 space-y-8">
      <p class="italic text-gray-500 text-center">Por favor, clique em <strong>Calcular Impostos</strong> para visualizar as tabelas.</p>
    </div>
  </div>

<script type="module">
  import FirebaseAPI from './firebaseApi.js';

  let resultados = {};
  let irsBrackets = null;

  document.getElementById('irsFileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      const data = evt.target.result;
      const wb = XLSX.read(data, { type: file.name.endsWith('.csv') ? 'string' : 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      const [header, ...rows] = json;
      const minIdx = header.findIndex(h => /min/i.test(h));
      const maxIdx = header.findIndex(h => /max/i.test(h));
      const rateIdx = header.findIndex(h => /rate|taxa/i.test(h));
      irsBrackets = rows.map(r => ({
        min: parseFloat(r[minIdx] || 0),
        max: parseFloat(r[maxIdx] || Infinity),
        rate: parseFloat(r[rateIdx] || 0)
      }));
      irsBrackets.sort((a, b) => a.min - b.min);
      alert('Tabela IRS importada com sucesso!');
    };
    reader.readAsArrayBuffer(file);
  });

  function filtrarPorData(lista, inicio, fim) {
    return lista.filter(tx => {
      const d = new Date(tx.date);
      return (!inicio || d >= new Date(inicio)) && (!fim || d <= new Date(fim));
    });
  }

  function calcProgressivo(amount) {
    if (!irsBrackets) return 0;
    let tax = 0;
    for (const b of irsBrackets) {
      if (amount <= b.min) break;
      const upper = Math.min(amount, b.max);
      tax += (upper - b.min) * (b.rate / 100);
    }
    return tax;
  }

  function gerarCSV() {
    const linhas = ["Tipo,Total ‚Ç¨,Imposto ‚Ç¨,Taxa utilizada"];
    linhas.push(`Despesas,${resultados.totalDespesas.toFixed(2)},${resultados.totalIVA.toFixed(2)},${resultados.ivaRate}%`);
    linhas.push(`Rendimentos,${resultados.totalRendimentos.toFixed(2)},${resultados.totalIRS_Rend.toFixed(2)},Progressivo`);
    linhas.push(`Investimentos,${resultados.totalInvestimentos.toFixed(2)},${resultados.totalIRS_Invest.toFixed(2)},Progressivo`);
    const blob = new Blob([linhas.join("\n")], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'impostos_wallet360.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("Resumo Fiscal Estimado - Wallet360", 10, 15);
    doc.setFontSize(12);
    doc.text(`üßæ IVA Despesas: ‚Ç¨${resultados.totalIVA.toFixed(2)} (${resultados.ivaRate}%)`, 10, 30);
    doc.text(`üíº IRS Rendimentos: ‚Ç¨${resultados.totalIRS_Rend.toFixed(2)} (Progressivo)`, 10, 40);
    doc.text(`üìà IRS Investimentos: ‚Ç¨${resultados.totalIRS_Invest.toFixed(2)} (Progressivo)`, 10, 50);
    doc.save("impostos_wallet360.pdf");
  }

  function renderTabelas(lista) {
    const container = document.getElementById('tabelas');
    container.innerHTML = '';
    const grupos = {
      'Despesas': lista.filter(tx => tx.type === 'expense'),
      'Rendimentos': lista.filter(tx => tx.type === 'income'),
      'Investimentos': lista.filter(tx => tx.type === 'investment')
    };
    Object.entries(grupos).forEach(([titulo, arr], idx) => {
      const div = document.createElement('div');
      div.innerHTML = `<h3 class="text-xl font-semibold mb-2">${titulo}</h3>`;
      if (!arr.length) {
        div.innerHTML += `<p class="italic text-gray-500">Sem ${titulo.toLowerCase()}.</p>`;
      } else {
        div.innerHTML += `
          <div class="overflow-x-auto">
            <table id="dt${idx}" class="min-w-full bg-white rounded-lg overflow-hidden display">
              <thead class="bg-gray-200"><tr>
                <th class="p-2">Data</th>
                <th class="p-2">Descri√ß√£o</th>
                <th class="p-2">Valor (‚Ç¨)</th>
                <th class="p-2">Imposto (‚Ç¨)</th>
              </tr></thead>
              <tbody>
                ${arr.map(tx => {
                  let imp = tx.type === 'expense'
                    ? tx.amount * (resultados.ivaRate / 100)
                    : calcProgressivo(tx.amount);
                  return `
                    <tr class="border-b">
                      <td class="p-2">${tx.date}</td>
                      <td class="p-2">${tx.description}</td>
                      <td class="p-2">‚Ç¨${tx.amount.toFixed(2)}</td>
                      <td class="p-2">‚Ç¨${imp.toFixed(2)}</td>
                    </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
      }
      container.appendChild(div);
      if (arr.length) {
        $(`#dt${idx}`).DataTable({
          dom: 'Bfrtip',
          buttons: ['copyHtml5', 'csvHtml5', 'excelHtml5', 'pdfHtml5', 'print']
        });
      }
    });
  }

  async function calcularImpostos() {
    // dedu√ß√µes
    const dedSaude  = parseFloat(document.getElementById('dedSaude').value) || 0;
    const dedEduc   = parseFloat(document.getElementById('dedEduc').value ) || 0;
    const dedHabit  = parseFloat(document.getElementById('dedHabit').value) || 0;
    const dedPPR    = parseFloat(document.getElementById('dedPPR').value  ) || 0;
    const dedDon    = parseFloat(document.getElementById('dedDon').value  ) || 0;
    const totalDed  = dedSaude + dedEduc + dedHabit + dedPPR + dedDon;

    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('resultado').classList.add('hidden');
    document.getElementById('tabelas').innerHTML = '';

    const start = document.getElementById('startDate').value;
    const end   = document.getElementById('endDate').value;
    const ivaRate = parseFloat(document.getElementById('ivaRate').value) || 0;

    const trans = await FirebaseAPI.fetchRecentTransactions();
    const filtr = filtrarPorData(trans, start, end);

    let totDesp = 0, totIVA = 0;
    let totRend = 0, totIRS_R = 0;
    let totInv  = 0, totIRS_I = 0;

    filtr.forEach(tx => {
      if (tx.type === 'expense') {
        totDesp += tx.amount;
        totIVA  += tx.amount * (ivaRate / 100);
      } else if (tx.type === 'income') {
        const baseRend = Math.max(0, tx.amount - totalDed);
        totRend   += tx.amount;
        totIRS_R  += calcProgressivo(baseRend);
      } else if (tx.type === 'investment') {
        totInv   += tx.amount;
        totIRS_I += calcProgressivo(tx.amount);
      }
    });

    resultados = {
      totalDespesas: totDesp,
      totalIVA:      totIVA,
      ivaRate,
      totalRendimentos: totRend,
      totalIRS_Rend:    totIRS_R,
      totalInvestimentos: totInv,
      totalIRS_Invest:    totIRS_I
    };

    document.getElementById('resultado').innerHTML = `
      <div class="bg-white rounded-xl shadow-lg p-6 space-y-6">
        <h2 class="text-2xl font-bold mb-4">Resumo Fiscal Estimado</h2>
        <p>üßæ IVA Despesas: <strong>‚Ç¨${totIVA.toFixed(2)}</strong> (${ivaRate}%)</p>
        <p>üíº IRS Rendimentos: <strong>‚Ç¨${totIRS_R.toFixed(2)}</strong> (Ap√≥s dedu√ß√µes)</p>
        <p>üìà IRS Investimentos: <strong>‚Ç¨${totIRS_I.toFixed(2)}</strong> (Progressivo)</p>
      </div>`;
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('resultado').classList.remove('hidden');

    renderTabelas(filtr);
  }

  document.getElementById('btnCalcular').addEventListener('click', calcularImpostos);
  document.getElementById('btnExportCSV').addEventListener('click', gerarCSV);
  document.getElementById('btnExportPDF').addEventListener('click', gerarPDF);
</script>
</body>
</html>
