<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cálculo de Impostos - Wallet360</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jQuery & DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KKP2317QMF');
</script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
   <!-- Header Widget Placeholder -->
  <div id="header-widget"></div>
  <script type="module" src="header.js"></script>
  
  <div class="max-w-4xl mx-auto py-16 px-4">
    <h1 class="text-3xl font-bold text-center mb-8">Cálculo de Impostos - Wallet360</h1>

    <div class="bg-indigo-100 p-6 rounded-lg shadow mb-6">
      <!-- Import IRS table -->
      <div class="mb-6">
        <label class="block mb-1 font-medium">Importar Tabela IRS (XLSX/CSV)</label>
        <input id="irsFileInput" type="file" accept=".xlsx,.csv" class="w-full p-2 rounded border">
      </div>
      <!-- Deductions -->
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Deduções Fiscais (€)</h2>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1">Saúde</label>
            <input id="dedSaude" type="number" value="0" class="w-full p-2 rounded border">
          </div>
          <div>
            <label class="block mb-1">Educação</label>
            <input id="dedEduc" type="number" value="0" class="w-full p-2 rounded border">
          </div>
          <div>
            <label class="block mb-1">Habitação</label>
            <input id="dedHabit" type="number" value="0" class="w-full p-2 rounded border">
          </div>
          <div>
            <label class="block mb-1">PPR</label>
            <input id="dedPPR" type="number" value="0" class="w-full p-2 rounded border">
          </div>
          <div>
            <label class="block mb-1">Donativos</label>
            <input id="dedDon" type="number" value="0" class="w-full p-2 rounded border">
          </div>
        </div>
      </div>
      <!-- Settings -->
      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block mb-1 font-medium">Data de Início</label>
          <input id="startDate" type="date" class="w-full p-2 rounded border">
        </div>
        <div>
          <label class="block mb-1 font-medium">Data de Fim</label>
          <input id="endDate" type="date" class="w-full p-2 rounded border">
        </div>
        <div>
          <label class="block mb-1 font-medium">Taxa IVA (%)</label>
          <input id="ivaRate" type="number" value="23" class="w-full p-2 rounded border">
        </div>
        <div>
          <label class="block mb-1 font-medium">Categoria IRS</label>
          <select id="irsCategory" class="w-full p-2 rounded border">
            <option value="A">Categoria A (Trabalho Dependente)</option>
            <option value="B">Categoria B (Trabalho Independente)</option>
            <option value="E">Categoria E (Rendimentos de Capitais)</option>
            <option value="F">Categoria F (Rendimentos Prediais)</option>
            <option value="G">Categoria G (Pensões)</option>
            <option value="H">Categoria H (Mais-valias)</option>
          </select>
        </div>
      </div>
      <div class="flex flex-wrap gap-4">
        <button id="btnCalcular" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded">Calcular Impostos</button>
        <button id="btnExportCSV" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded">Exportar CSV</button>
        <button id="btnExportPDF" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded">Exportar PDF</button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="flex items-center justify-center space-x-2 hidden">
      <svg class="animate-spin h-6 w-6 text-indigo-600" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/></svg>
      <span class="text-indigo-600">A processar, por favor aguarde...</span>
    </div>

  

    <!-- Results -->
    <div id="resultado" class="mt-8 hidden"></div>
      <!-- Deduction Tables -->
    <div id="deductionTables" class="mt-8 hidden bg-white p-6 rounded shadow">
      <h3 class="text-xl font-semibold mb-4">Tabela de Deduções</h3>
      <div class="overflow-x-auto">
        <table id="deductionsTable" class="min-w-full">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2 text-left">Categoria</th>
              <th class="p-2 text-right">Automática (€)</th>
              <th class="p-2 text-right">Manual (€)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Transaction Tables -->
    <div id="tabelas" class="mt-12 space-y-8">
      <p class="italic text-gray-500 text-center">Clique em <strong>Calcular Impostos</strong> para ver as tabelas.</p>
    </div>
  </div>

  <script type="module">
    import FirebaseAPI from './firebaseApi.js';

    let resultados = {};
    let irsBrackets = null;

    document.getElementById('irsFileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const wb = XLSX.read(evt.target.result, { type: file.name.endsWith('.csv') ? 'string' : 'array' });
        const [header, ...rows] = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
        const minIdx  = header.findIndex(h => /min/i.test(h));
        const maxIdx  = header.findIndex(h => /max/i.test(h));
        const rateIdx = header.findIndex(h => /rate|taxa/i.test(h));
        irsBrackets = rows.map(r => ({
          min:  parseFloat(r[minIdx]  || 0),
          max:  parseFloat(r[maxIdx]  || Infinity),
          rate: parseFloat(r[rateIdx] || 0)
        })).sort((a,b)=>a.min-b.min);
        alert('Tabela IRS importada com sucesso!');
      };
      reader.readAsArrayBuffer(file);
    });

    function filtrarPorData(list, start, end) {
      return list.filter(tx => {
        const d = new Date(tx.date);
        return (!start || d >= new Date(start)) && (!end || d <= new Date(end));
      });
    }

    function calcProgressivo(valor) {
      if (!irsBrackets) return 0;
      let total = 0;
      for (const b of irsBrackets) {
        if (valor <= b.min) break;
        const upto = Math.min(valor, b.max);
        total += (upto - b.min) * (b.rate/100);
      }
      return total;
    }

    function gerarCSV() {
      const linhas = [
        "Tipo,Total €,Imposto €,Taxa",
        `Despesas,${resultados.totalDespesas.toFixed(2)},${resultados.totalIVA.toFixed(2)},${resultados.ivaRate}%`,
        `Rendimentos,${resultados.totalRendimentos.toFixed(2)},${resultados.totalIRS_Rend.toFixed(2)},Progressivo`,
        `Investimentos,${resultados.totalInvestimentos.toFixed(2)},${resultados.totalIRS_Invest.toFixed(2)},Progressivo`
      ];
      const blob = new Blob([linhas.join("\n")], { type:'text/csv' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'impostos.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14).text("Resumo Fiscal - Wallet360", 10, 15);
      doc.setFontSize(12);
      doc.text(`IVA Despesas: €${resultados.totalIVA.toFixed(2)} (${resultados.ivaRate}%)`, 10, 30);
      doc.text(`Deduções: €${resultados.totalDed.toFixed(2)}`, 10, 40);
      doc.text(`IRS Rendimentos: €${resultados.totalIRS_Rend.toFixed(2)}`, 10, 50);
      doc.text(`IRS Investimentos: €${resultados.totalIRS_Invest.toFixed(2)}`, 10, 60);
      doc.save("impostos.pdf");
    }

    function renderDeductionsTable(auto, manual) {
      const tbody = document.querySelector("#deductionsTable tbody");
      tbody.innerHTML = "";
      const cats = ["saude","educacao","habitacao","ppr","donativos"];
      const names = { saude:"Saúde", educacao:"Educação", habitacao:"Habitação", ppr:"PPR", donativos:"Donativos" };
      cats.forEach(cat => {
        const tr = document.createElement("tr");
        tr.classList.add("border-y");
        tr.innerHTML = `
          <td class="p-2">${names[cat]}</td>
          <td class="p-2 text-right">€${auto[cat].toFixed(2)}</td>
          <td class="p-2 text-right">€${manual[cat].toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("deductionTables").classList.remove("hidden");
    }

    function renderTabelas(list) {
      const container = document.getElementById("tabelas");
      container.innerHTML = "";
      const groups = {
        "Despesas":     list.filter(tx=>tx.type==="expense"),
        "Rendimentos":  list.filter(tx=>tx.type==="income"),
        "Investimentos":list.filter(tx=>tx.type==="investment")
      };
      Object.entries(groups).forEach(([title, arr], i) => {
        const div = document.createElement("div");
        div.innerHTML = `<h3 class="text-xl font-semibold mb-2">${title}</h3>`;
        if (!arr.length) {
          div.innerHTML += `<p class="italic text-gray-500">Sem ${title.toLowerCase()}.</p>`;
        } else {
          div.innerHTML += `
            <div class="overflow-x-auto">
              <table id="dt${i}" class="min-w-full bg-white">
                <thead class="bg-gray-200"><tr>
                  <th class="p-2">Data</th>
                  <th class="p-2">Descrição</th>
                  <th class="p-2">Valor (€)</th>
                  <th class="p-2">Imposto (€)</th>
                </tr></thead>
                <tbody>
                  ${arr.map(tx=>{
                    const imp = tx.type==="expense"
                      ? tx.amount*(resultados.ivaRate/100)
                      : calcProgressivo(tx.type==="income"? resultados.baseRend : tx.amount);
                    return `
                      <tr class="border-b">
                        <td class="p-2">${tx.date}</td>
                        <td class="p-2">${tx.description}</td>
                        <td class="p-2">€${tx.amount.toFixed(2)}</td>
                        <td class="p-2">€${imp.toFixed(2)}</td>
                      </tr>`;
                  }).join("")}
                </tbody>
              </table>
            </div>`;
        }
        container.appendChild(div);
        if (arr.length) {
          $(`#dt${i}`).DataTable({
            dom: 'Bfrtip',
            buttons: ['copy','csv','excel','pdf','print']
          });
        }
      });
    }

    async function calcularImpostos() {
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("resultado").classList.add("hidden");
      document.getElementById("tabelas").innerHTML = "";
      document.getElementById("deductionTables").classList.add("hidden");

      const start   = document.getElementById("startDate").value;
      const end     = document.getElementById("endDate").value;
      const ivaRate = parseFloat(document.getElementById("ivaRate").value)||0;

      const trans = await FirebaseAPI.fetchRecentTransactions();
      const filtr = filtrarPorData(trans, start, end);

      // auto deductions
      const auto = {
        saude:     filtr.filter(tx=>tx.type==="expense"&&tx.category==="saude").reduce((s,tx)=>s+tx.amount,0),
        educacao:  filtr.filter(tx=>tx.type==="expense"&&tx.category==="educacao").reduce((s,tx)=>s+tx.amount,0),
        habitacao: filtr.filter(tx=>tx.type==="expense"&&tx.category==="habitacao").reduce((s,tx)=>s+tx.amount,0),
        ppr:       filtr.filter(tx=>tx.type==="expense"&&tx.category==="ppr").reduce((s,tx)=>s+tx.amount,0),
        donativos: filtr.filter(tx=>tx.type==="expense"&&tx.category==="donativos").reduce((s,tx)=>s+tx.amount,0)
      };
      // manual deductions
      const manual = {
        saude:     parseFloat(document.getElementById("dedSaude").value)||0,
        educacao:  parseFloat(document.getElementById("dedEduc").value)||0,
        habitacao: parseFloat(document.getElementById("dedHabit").value)||0,
        ppr:       parseFloat(document.getElementById("dedPPR").value)||0,
        donativos: parseFloat(document.getElementById("dedDon").value)||0
      };
      // update inputs for auto
      Object.entries(auto).forEach(([cat,v])=>{
        const input = document.getElementById({
          saude:"dedSaude",educacao:"dedEduc",habitacao:"dedHabit",ppr:"dedPPR",donativos:"dedDon"
        }[cat]);
        if (input) input.value = v.toFixed(2);
      });

      const totalDed = Object.values(auto).reduce((sum,v)=>sum+v,0)
                     + Object.values(manual).reduce((sum,v)=>sum+v,0);

      let totDesp=0, totIVA=0, totRend=0, totInv=0;
      filtr.forEach(tx=>{
        if (tx.type==="expense") {
          totDesp+=tx.amount;
          totIVA+=tx.amount*(ivaRate/100);
        } else if (tx.type==="income") {
          totRend+=tx.amount;
        } else if (tx.type==="investment") {
          totInv+=tx.amount;
        }
      });

      const baseRend = Math.max(0, totRend - totalDed);
      const totIRS_R = calcProgressivo(baseRend);
      let totIRS_I = 0;
      filtr.filter(tx=>tx.type==="investment").forEach(tx=> totIRS_I+=calcProgressivo(tx.amount));

      resultados = {
        totalDespesas:totDesp,
        totalIVA:totIVA,
        ivaRate,
        totalRendimentos:totRend,
        totalDed,
        baseRend,
        totalIRS_Rend:totIRS_R,
        totalInvestimentos:totInv,
        totalIRS_Invest:totIRS_I
      };

      renderDeductionsTable(auto, manual);

      document.getElementById("resultado").innerHTML = `
        <div class="bg-white rounded shadow p-6 space-y-4">
          <h2 class="text-2xl font-bold">Resumo Fiscal</h2>
          <p>🧾 Despesas: €${totDesp.toFixed(2)}, IVA: €${totIVA.toFixed(2)} (${ivaRate}%)</p>
          <p>💰 Rendimentos: €${totRend.toFixed(2)}, Deduções: €${totalDed.toFixed(2)}</p>
          <p>💼 IRS Rendimentos: €${totIRS_R.toFixed(2)} (↑ base €${baseRend.toFixed(2)})</p>
          <p>📈 Investimentos: €${totInv.toFixed(2)}, IRS: €${totIRS_I.toFixed(2)}</p>
        </div>`;

      document.getElementById("loading").classList.add("hidden");
      document.getElementById("resultado").classList.remove("hidden");
      renderTabelas(filtr);
    }

    document.getElementById("btnCalcular").addEventListener("click", calcularImpostos);
    document.getElementById("btnExportCSV").addEventListener("click", gerarCSV);
    document.getElementById("btnExportPDF").addEventListener("click", gerarPDF);
  </script>
</body>
</html>
