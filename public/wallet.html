<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carteira de Investimentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);min-height:100vh}
    .card-hover{transition:.3s}.card-hover:hover{transform:translateY(-4px)}
  </style>
</head>

<body class="text-white font-sans">
  <div id="header-widget"></div>
  <script type="module" src="header.js"></script>

  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">üíº Nova Wallet</h1>
          <p class="text-gray-400 mt-2">Dashboard com comiss√µes e lucro em tempo real</p>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-400">√öltima atualiza√ß√£o</div>
          <div id="lastUpdate" class="text-green-400 font-semibold"></div>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium text-gray-400">Saldo Total</h3><span class="text-2xl">üí∞</span></div>
        <div id="saldoTotal" class="text-3xl font-bold text-green-400">‚Ç¨ 0</div><p class="text-xs text-gray-500 mt-1">* Deduzido comiss√µes</p>
      </div>
      <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium text-gray-400">Lucro/Preju√≠zo</h3><span class="text-2xl">üìà</span></div>
        <div id="lucroTotal" class="text-3xl font-bold">‚Ç¨ 0</div><div id="lucroPercentual" class="text-sm mt-1">0.00%</div>
      </div>
      <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium text-gray-400">Total Investido</h3><span class="text-2xl">üí∏</span></div>
        <div id="totalInvestido" class="text-3xl font-bold text-blue-400">‚Ç¨ 0</div><div id="totalAcoes" class="text-xs text-gray-500 mt-1">0 a√ß√µes</div>
      </div>
      <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2"><h3 class="text-sm font-medium text-gray-400">Comiss√µes</h3><span class="text-2xl">üè¶</span></div>
        <div id="totalComissoes" class="text-3xl font-bold text-red-400">‚Ç¨ 0</div><div id="comissaoPercentual" class="text-xs text-gray-500 mt-1">0.00% do total</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-4 text-gray-200">Distribui√ß√£o da Carteira</h3>
        <div class="h-64"><canvas id="pieChart"></canvas></div>
      </div>
      <div class="bg-gray-800/50 p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-4 text-gray-200">Performance por Ativo</h3>
        <div class="h-64"><canvas id="barChart"></canvas></div>
      </div>
    </div>

    <section class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-200">Carteira de Investimentos</h2>
        <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">üîÑ Atualizar Pre√ßos</button>
      </div>
      <div id="carteiraContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-200">Transa√ß√µes Recentes</h2>
        <div class="flex gap-2">
          <select id="filterTipo" class="bg-gray-700 text-white px-3 py-1 rounded text-sm"><option value="">Todos</option><option value="Compra">Compra</option><option value="Venda">Venda</option></select>
          <input id="searchSymbol" class="bg-gray-700 text-white px-3 py-1 rounded text-sm w-32" placeholder="Buscar s√≠mbolo...">
        </div>
      </div>
      <div class="bg-gray-800/50 rounded-xl overflow-hidden shadow-lg border border-gray-700">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-700/50 text-gray-300"><tr><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">S√≠mbolo</th><th class="px-6 py-3">Qtd.</th><th class="px-6 py-3">Pre√ßo</th><th class="px-6 py-3">Comiss√£o</th><th class="px-6 py-3">Total</th><th class="px-6 py-3">Data</th></tr></thead>
            <tbody id="transacoesTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { auth } from './firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    const carteira=[],transacoes=[],cores=['#0ea5e9','#8b5cf6','#22c55e','#f97316','#f43f5e'];
    let filteredTransacoes=[],pieChart,barChart,currentUserEmail='';
    const ‚Ç¨=v=>`‚Ç¨ ${Number(v).toFixed(2)}`;
    const apiTx=e=>`/api/transactions?user=${encodeURIComponent(e)}`;
    const apiPx=s=>`/api/stocks?symbol=${encodeURIComponent(s)}`;

    const mapTx=r=>({
      id      : r.id??r._id??crypto.randomUUID(),
      symbol  : (r.symbol??r.ticker??r.ativo??'').toUpperCase(),
      operation: r.operation??r.type??r.side??'',
      amount  : +(r.amount??r.quantity??r.qtd??0),
      price   : +(r.price??r.unitPrice??r.valor??0),
      fee     : +(r.fee??r.commission??r.custo??0),
      date    : r.date??r.tradeDate??r.data??''
    });

    const fetchPx=async(s,f)=>{try{return(await(await fetch(apiPx(s))).json()).price??f}catch{return f}};

    async function construirCarteira(){
      carteira.length=0;
      const m=new Map;
      transacoes.forEach(t=>{
        const mult=t.operation==='buy'?1:-1;
        if(!m.has(t.symbol))m.set(t.symbol,{nome:t.symbol,acoes:0,despesa:0});
        const p=m.get(t.symbol);
        p.acoes+=mult*t.amount;
        p.despesa+=mult*t.amount*t.price;
      });
      await Promise.all([...m.values()].filter(p=>p.acoes>0).map(async p=>{
        p.precoCompra=Math.abs(p.despesa)/p.acoes;
        p.precoAtual=await fetchPx(p.nome,p.precoCompra);
        carteira.push(p);
      }));
    }

    function calcularMetricas(){
      const com=transacoes.reduce((s,t)=>s+t.fee,0);
      const inv=carteira.reduce((s,a)=>s+a.precoCompra*a.acoes,0);
      const val=carteira.reduce((s,a)=>s+a.precoAtual*a.acoes,0);
      const acs=carteira.reduce((s,a)=>s+a.acoes,0);
      const luc=val-inv;
      const lp=inv?luc/inv*100:0;
      const cp=inv?com/inv*100:0;
      document.getElementById('totalComissoes').textContent=‚Ç¨(com);
      document.getElementById('comissaoPercentual').textContent=`${cp.toFixed(2)}% do total`;
      document.getElementById('totalInvestido').textContent=‚Ç¨(inv);
      document.getElementById('totalAcoes').textContent=`${acs} a√ß√µes`;
      document.getElementById('saldoTotal').textContent=‚Ç¨(val-com);
      const l=document.getElementById('lucroTotal');
      l.textContent=‚Ç¨(luc);l.className=`text-3xl font-bold ${luc>=0?'text-green-400':'text-red-400'}`;
      document.getElementById('lucroPercentual').textContent=`${lp.toFixed(2)}%`;
      document.getElementById('lastUpdate').textContent=new Date().toLocaleString('pt-PT');
    }

    function renderCarteira(){
      const c=document.getElementById('carteiraContainer');c.innerHTML='';
      carteira.forEach(a=>{
        const lucro=(a.precoAtual-a.precoCompra)*a.acoes;
        c.insertAdjacentHTML('beforeend',
          `<div class="bg-gray-800 p-4 rounded-xl border border-gray-700 card-hover shadow">
            <h3 class="text-xl font-bold text-blue-300">${a.nome}</h3>
            <p class="text-sm text-gray-400">${a.acoes} a√ß√µes</p>
            <p class="text-sm text-gray-400">Compra: ${‚Ç¨(a.precoCompra)}</p>
            <p class="text-sm text-gray-400">Atual: ${‚Ç¨(a.precoAtual)}</p>
            <p class="mt-2 text-sm font-semibold ${lucro>=0?'text-green-400':'text-red-400'}">Lucro: ${‚Ç¨(lucro)}</p>
          </div>`);
      });
    }

    function renderTransacoes(){
      const t=document.getElementById('transacoesTable');t.innerHTML='';
      filteredTransacoes.forEach(x=>{
        const tot=x.price*x.amount+x.fee;
        const opClass=x.operation==='buy'?'bg-green-600 text-white':'bg-red-600 text-white';
        const opText =x.operation==='buy'?'Compra':'Venda';
        t.insertAdjacentHTML('beforeend',
          `<tr class="border-t border-gray-700 hover:bg-gray-700/30">
            <td class="px-6 py-2"><span class="px-2 py-1 rounded ${opClass}">${opText}</span></td>
            <td class="px-6 py-2">${x.symbol}</td>
            <td class="px-6 py-2">${x.amount}</td>
            <td class="px-6 py-2">${‚Ç¨(x.price)}</td>
            <td class="px-6 py-2 text-red-400">${‚Ç¨(x.fee)}</td>
            <td class="px-6 py-2">${‚Ç¨(tot)}</td>
            <td class="px-6 py-2">${x.date}</td>
          </tr>`);
      });
    }

    function renderGraficos(){
      const labels=carteira.map(a=>a.nome);
      const valores=carteira.map(a=>a.precoAtual*a.acoes);
      const lucros=carteira.map(a=>(a.precoAtual-a.precoCompra)*a.acoes);
      if(pieChart)pieChart.destroy();
      pieChart=new Chart(document.getElementById('pieChart'),{
        type:'pie',
        data:{labels,datasets:[{data:valores,backgroundColor:cores}]},
        options:{responsive:true,plugins:{legend:{labels:{color:'#fff',boxWidth:14}}}}
      });
      if(barChart)barChart.destroy();
      barChart=new Chart(document.getElementById('barChart'),{
        type:'bar',
        data:{labels,datasets:[{data:lucros,backgroundColor:cores}]},
        options:{responsive:true,plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:'#fff'},grid:{display:false}},y:{ticks:{color:'#fff'},grid:{color:'#334155'}}}}
      });
    }

    function filtrar(){
      const tp=document.getElementById('filterTipo').value;
      const sb=document.getElementById('searchSymbol').value.toUpperCase();
      filteredTransacoes=transacoes.filter(z=>(!tp||z.operation===(tp==='Compra'?'buy':'sell'))&&(!sb||z.symbol.includes(sb)));
      renderTransacoes();
    }

    document.getElementById('filterTipo').addEventListener('change',filtrar);
    document.getElementById('searchSymbol').addEventListener('input',filtrar);
    document.getElementById('refreshBtn').addEventListener('click',async()=>{await construirCarteira();calcularMetricas();renderCarteira();renderGraficos()});

    async function loadTransacoes(){
      const r=await fetch(apiTx(currentUserEmail));
      const raw=await r.json();
      transacoes.length=0;
      raw.map(mapTx).forEach(t=>transacoes.push(t));
      filteredTransacoes=[...transacoes];
      await construirCarteira();calcularMetricas();renderCarteira();renderGraficos();renderTransacoes();
    }

    onAuthStateChanged(auth,u=>{if(!u)return location='/login.html';currentUserEmail=u.email;loadTransacoes()});
  </script>
</body>
</html>
