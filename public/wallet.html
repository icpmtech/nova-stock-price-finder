<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carteira de Investimentos</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
    }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-4px); }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
  </style>
</head>

<body class="text-white font-sans">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            üíº Nova Wallet
          </h1>
          <p class="text-gray-400 mt-2">Dashboard com comiss√µes e lucro em tempo real</p>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-400">√öltima atualiza√ß√£o</div>
          <div id="lastUpdate" class="text-green-400 font-semibold"></div>
        </div>
      </div>
    </header>

    <!-- M√©tricas principais -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Saldo -->
      <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-gray-400">Saldo Total</h3>
          <span class="text-2xl">üí∞</span>
        </div>
        <div id="saldoTotal" class="text-3xl font-bold text-green-400">‚Ç¨ 0</div>
        <p class="text-xs text-gray-500 mt-1">* Deduzido comiss√µes</p>
      </div>

      <!-- Lucro -->
      <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-gray-400">Lucro/Preju√≠zo</h3>
          <span class="text-2xl">üìà</span>
        </div>
        <div id="lucroTotal" class="text-3xl font-bold">‚Ç¨ 0</div>
        <div id="lucroPercentual" class="text-sm mt-1">0.00%</div>
      </div>

      <!-- Investido -->
      <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-gray-400">Total Investido</h3>
          <span class="text-2xl">üí∏</span>
        </div>
        <div id="totalInvestido" class="text-3xl font-bold text-blue-400">‚Ç¨ 0</div>
        <div id="totalAcoes" class="text-xs text-gray-500 mt-1">0 a√ß√µes</div>
      </div>

      <!-- Comiss√µes -->
      <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg card-hover border border-gray-700">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-medium text-gray-400">Comiss√µes</h3>
          <span class="text-2xl">üè¶</span>
        </div>
        <div id="totalComissoes" class="text-3xl font-bold text-red-400">‚Ç¨ 0</div>
        <div id="comissaoPercentual" class="text-xs text-gray-500 mt-1">0.00% do total</div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Pizza -->
      <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-4 text-gray-200">Distribui√ß√£o da Carteira</h3>
        <div class="h-64"><canvas id="pieChart"></canvas></div>
      </div>

      <!-- Barras -->
      <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-4 text-gray-200">Performance por Ativo</h3>
        <div class="h-64"><canvas id="barChart"></canvas></div>
      </div>
    </div>

    <!-- Carteira -->
    <section class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-200">Carteira de Investimentos</h2>
        <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
          üîÑ Atualizar Pre√ßos
        </button>
      </div>
      <div id="carteiraContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- Transa√ß√µes -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold text-gray-200">Transa√ß√µes Recentes</h2>
        <div class="flex gap-2">
          <select id="filterTipo" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
            <option value="">Todos os tipos</option>
            <option value="Compra">Compra</option>
            <option value="Venda">Venda</option>
          </select>
          <input id="searchSymbol" type="text" placeholder="Buscar s√≠mbolo..."
                 class="bg-gray-700 text-white px-3 py-1 rounded text-sm w-32">
        </div>
      </div>

      <div class="bg-gray-800/50 backdrop-blur-sm rounded-xl overflow-hidden shadow-lg border border-gray-700">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead class="bg-gray-700/50 text-gray-300">
              <tr>
                <th class="px-6 py-3 font-semibold">Tipo</th>
                <th class="px-6 py-3 font-semibold">S√≠mbolo</th>
                <th class="px-6 py-3 font-semibold">Quantidade</th>
                <th class="px-6 py-3 font-semibold">Pre√ßo</th>
                <th class="px-6 py-3 font-semibold">Comiss√£o</th>
                <th class="px-6 py-3 font-semibold">Total</th>
                <th class="px-6 py-3 font-semibold">Data</th>
              </tr>
            </thead>
            <tbody id="transacoesTable"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Script principal -->
  
    <!-- ‚¨áÔ∏è SUBSTITUI **apenas** o bloco de dados est√°ticos + inicializa√ß√£o por este c√≥digo -->
<script type="module">
/* ----------- Firebase login ----------- */
import { auth } from './firebase-init.js';
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

/* ----------- Estado ----------- */
const carteira   = [];            // ser√° calculada
const transacoes = [];            // vir√° da API
let filteredTransacoes = [];
let pieChart, barChart;
let currentUserEmail = '';

/* ----------- Helpers ----------- */
const cores = ['#0ea5e9','#8b5cf6','#22c55e','#f97316','#f43f5e'];      // paleta fixa

/* --- Fetch pre√ßo actual (exemplo simples; substitui por API real se quiser) --- */
async function getCurrentPrice(symbol, fallback) {
  try {
    const r = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`);
    const json = await r.json();
    return json.quoteResponse.result[0]?.regularMarketPrice ?? fallback;
  } catch { return fallback; }
}

/* ----------- Construir carteira a partir de transa√ß√µes ----------- */
async function construirCarteira() {
  carteira.length = 0;
  const m = new Map();

  // Agrega posi√ß√£o por s√≠mbolo
  transacoes.forEach(tx => {
    const mult  = tx.tipo === 'Compra' ? 1 : -1;
    if (!m.has(tx.simbolo)) m.set(tx.simbolo, { nome: tx.simbolo, acoes: 0, despesa: 0 });
    const at = m.get(tx.simbolo);
    at.acoes   += mult * tx.quantidade;
    at.despesa += mult * tx.quantidade * tx.preco;   // negativo numa venda
  });

  // Calcula pre√ßo m√©dio e obt√©m pre√ßo actual
  for (const at of m.values()) {
    if (at.acoes <= 0) continue;                     // elimina posi√ß√µes fechadas
    at.precoCompra = Math.abs(at.despesa) / at.acoes;
    at.precoAtual  = await getCurrentPrice(at.nome, at.precoCompra);
    at.setor       = '‚Äî';                            // placeholder
    carteira.push(at);
  }
}

/* ----------- Obter transa√ß√µes do utilizador ----------- */
async function loadTransacoes() {
  try {
    const res = await fetch(`/api/transactions?user=${encodeURIComponent(currentUserEmail)}`);
    const data = await res.json();                   // espera formato {symbol,operation,amount,price,fee,date}

    transacoes.length = 0;                           // limpa
    data.forEach(t => transacoes.push({
      tipo       : t.operation === 'buy' ? 'Compra' : 'Venda',
      simbolo    : t.symbol.toUpperCase(),
      quantidade : t.amount,
      preco      : t.price,
      comissao   : t.fee,
      data       : t.date
    }));

    filteredTransacoes = [...transacoes];
    await construirCarteira();
    calcularMetricas();
    renderCarteira();
    renderGraficos();
    renderTransacoes();
  } catch(err) {
    console.error('Erro ao obter transa√ß√µes', err);
    alert('Falha ao carregar transa√ß√µes');
  }
}

/* ----------- FUN√á√ïES DE UI (mant√©m as tuas vers√µes) ----------- */
function calcularMetricas(){ /* idem ao teu c√≥digo actual */ }
function renderCarteira()   { /* idem */ }
function renderTransacoes() { /* idem */ }
function renderGraficos()   { /* idem, mas usa ‚Äúcores‚Äù */ }
function filtrarTransacoes(){ /* idem */ }

/* ----------- Listeners de filtros / refresh (mant√©m) ----------- */
document.getElementById('filterTipo'  ).addEventListener('change', filtrarTransacoes);
document.getElementById('searchSymbol').addEventListener('input',  filtrarTransacoes);
document.getElementById('refreshBtn').addEventListener('click', async () => {
  await construirCarteira();
  calcularMetricas();
  renderCarteira();
  renderGraficos();
});

/* ----------- Arranque: garante utilizador logado e carrega dados ----------- */
onAuthStateChanged(auth, user => {
  if (!user) return (location = '/login.html');
  currentUserEmail = user.email;
  loadTransacoes();
});
</script>
  
</body>
</html>
