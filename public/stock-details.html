<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Dashboard</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Plotly JS -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <div class="container mx-auto p-4 space-y-8">

    <!-- ─── Header ──────────────────────────────────────── -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <h1 class="text-3xl font-extrabold tracking-tight">
        <span id="companyName">—</span>
        <span class="text-base font-semibold text-gray-500" id="symbolLabel">(—)</span>
      </h1>
      <div class="flex items-baseline gap-1">
        <span id="currentPrice" class="text-3xl font-semibold">€—</span>
        <span id="priceChange" class="text-sm font-medium">(—)</span>
      </div>
    </header>

    <!-- ─── Company Profile ─────────────────────────────── -->
    <section class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-lg font-semibold mb-4">Company Profile</h2>
      <div class="grid sm:grid-cols-3 gap-4 text-sm" id="profileGrid"></div>
      <p id="companyDescription" class="mt-4 text-sm leading-relaxed"></p>
    </section>

    <!-- ─── Key Stats Grid ───────────────────────────────── -->
    <section id="statsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></section>

    <!-- ─── Charts ──────────────────────────────────────── -->
    <section class="grid md:grid-cols-2 gap-8">
      <!-- Historical Price Line -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Historical Price (52 Weeks)</h2>
        <div id="priceChart" class="h-72"></div>
      </div>

      <!-- Revenue vs Earnings Bars -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Revenue vs Earnings (Annual)</h2>
        <div id="revChart" class="h-72"></div>
      </div>

      <!-- Analyst Price Targets -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Analyst Price Targets</h2>
        <div id="targetChart" class="h-60"></div>
      </div>

      <!-- Sustainability Gauge -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-2">Controversy Level</h2>
        <div id="gaugeChart" class="h-60"></div>
      </div>
    </section>
  </div>

  <!-- ─── Front-End Logic ──────────────────────────────── -->
  <script>
    /* Helper – cria card de KPI */
    const createStatCard = (label, value) => `
      <div class="bg-white rounded-2xl shadow p-4">
        <p class="text-xs text-gray-500">${label}</p>
        <p class="text-xl font-semibold">${value}</p>
      </div>`;

    /* Carrega dados da API e popula UI */
    async function loadStock(symbol = 'NOS.LS') {
      try {
        const res = await fetch(`/api/stock?symbol=${encodeURIComponent(symbol)}`);
        if (!res.ok) throw new Error('Erro na API');
        const data = await res.json();

        /* Header */
        document.getElementById('companyName').textContent = data.name;
        document.getElementById('symbolLabel').textContent = `(${data.symbol})`;
        document.getElementById('currentPrice').textContent = `€${data.price.toFixed(2)}`;

        const change   = data.priceChange;
        const changePc = data.priceChangePercent * 100;
        const chEl     = document.getElementById('priceChange');
        chEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePc.toFixed(2)}%)`;
        chEl.className   = `text-sm font-medium ${change >= 0 ? 'text-green-600' : 'text-red-600'}`;

        /* Profile */
        document.getElementById('profileGrid').innerHTML = `
          <div><span class="font-medium">Sector:</span> ${data.sector}</div>
          <div><span class="font-medium">Industry:</span> ${data.industry}</div>
          <div><span class="font-medium">Employees:</span> ${data.employees?.toLocaleString?.() ?? '—'}</div>
        `;
        document.getElementById('companyDescription').textContent = data.description;

        /* KPI cards */
        const stats = [
          ['Previous Close', `€${data.previousClose.toFixed(4)}`],
          ['Open', `€${data.open.toFixed(4)}`],
          ['Volume', data.volume.toLocaleString()],
          ['Avg. Volume (3M)', data.avgVolume.toLocaleString()],
          ['Market Cap', `€${(data.marketCap / 1e9).toFixed(2)} B`],
          ['P/E (TTM)', data.peRatio?.toFixed?.(2) ?? '—'],
          ['Beta', data.beta?.toFixed?.(2) ?? '—'],
          ['Dividend Yield', `${(data.dividendYield * 100).toFixed(2)} %`],
          ['52 Wk Range', `€${data.week52Low.toFixed(2)} – €${data.week52High.toFixed(2)}`],
        ];
        document.getElementById('statsGrid').innerHTML = stats
          .map(([l, v]) => createStatCard(l, v))
          .join('');

        /* Charts */
        Plotly.react(
          'priceChart',
          [{
            x: data.history.dates,
            y: data.history.prices,
            type: 'scatter',
            mode: 'lines',
            line: { width: 2 },
            hovertemplate: '%{x}<br>€%{y:.2f}<extra></extra>',
          }],
          {
            margin: { t: 10, r: 10, l: 40, b: 40 },
            yaxis: { title: '€', tickprefix: '€' },
            xaxis: { title: 'Date' },
            displayModeBar: false,
          }
        );

        Plotly.react(
          'revChart',
          [
            {
              x: data.financials.years,
              y: data.financials.revenue,
              type: 'bar',
              name: 'Revenue (€M)',
              hovertemplate: 'Revenue<br>%{x}: €%{y}M<extra></extra>',
            },
            {
              x: data.financials.years,
              y: data.financials.earnings,
              type: 'bar',
              name: 'Earnings (€M)',
              hovertemplate: 'Earnings<br>%{x}: €%{y}M<extra></extra>',
            },
          ],
          {
            barmode: 'group',
            margin: { t: 10, r: 10, l: 40, b: 40 },
            yaxis: { title: '€ Million' },
            displayModeBar: false,
          }
        );

        const { low, mean, high } = data.analystTargets;
        Plotly.react(
          'targetChart',
          [
            {
              x: [high - low],
              y: ['Target Range'],
              base: [low],
              orientation: 'h',
              type: 'bar',
              marker: { color: '#cbd5e1' },
              hovertemplate: `Range: €${low} – €${high}<extra></extra>`,
              showlegend: false,
            },
            {
              x: [0],
              y: ['Target Range'],
              type: 'scatter',
              mode: 'markers+text',
              marker: { symbol: 'triangle-up', size: 14, color: '#1d4ed8' },
              text: [`Current €${data.price.toFixed(2)}`],
              textposition: 'top center',
              hovertemplate: `Current Price €${data.price}<extra></extra>`,
            },
            {
              x: [mean - low],
              y: ['Target Range'],
              base: [low],
              orientation: 'h',
              type: 'bar',
              marker: { color: '#6ee7b7' },
              hovertemplate: `Mean Target €${mean}<extra></extra>`,
              showlegend: false,
            },
          ],
          {
            margin: { t: 10, r: 10, l: 40, b: 20 },
            xaxis: { title: '€', range: [low * 0.95, high * 1.05], tickprefix: '€' },
            yaxis: { visible: false },
            displayModeBar: false,
          }
        );

        Plotly.react(
          'gaugeChart',
          [
            {
              type: 'indicator',
              mode: 'gauge+number',
              value: data.controversy,
              number: { suffix: ' / 5' },
              gauge: {
                axis: { range: [0, 5] },
                bar: { color: '#111827' },
                steps: [
                  { range: [0, 1], color: '#4ade80' },
                  { range: [1, 2], color: '#bef264' },
                  { range: [2, 3], color: '#fde047' },
                  { range: [3, 4], color: '#facc15' },
                  { range: [4, 5], color: '#f43f5e' },
                ],
              },
            },
          ],
          {
            margin: { t: 10, r: 10, l: 10, b: 10 },
            displayModeBar: false,
          }
        );
      } catch (err) {
        alert('Failed to load stock data: ' + err.message);
        console.error(err);
      }
    }

    /* Lê ?symbol= da URL */
    const urlParams = new URLSearchParams(window.location.search);
    loadStock(urlParams.get('symbol') || 'NOS.LS');
  </script>
</body>
</html>
