
<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet 360 - Leitor de Faturas</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="module">
    /* ---------------------------- Firebase -------------------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:            "AIzaSyBou0myKBfv_Drp6wnUUb-x0cG7bIqlo4w",
      authDomain:        "novamarketshub.firebaseapp.com",
      projectId:         "novamarketshub",
      storageBucket:     "novamarketshub.appspot.com",
      messagingSenderId: "280260544447",
      appId:             "1:280260544447:web:6c16387f3550662abf430a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------------------------- Estado ---------------------------------- */
    let scanner      = null;
    let paused       = false;
    let isProcessing = false;
    let cameraIndex  = 0;
    let pendingInv   = null;

    /* ---------------------------- Parser ---------------------------------- */
    function parseFaturaQR(raw){
      const SEP = raw.includes('*')?'*':';';
      const map = {};
      raw.split(SEP).forEach(p=>{
        const [k,...v]=p.split(':'); if(k&&v.length) map[k.trim().toUpperCase()]=v.join(':').trim();
      });
      const total = map.D ? (/[.,]/.test(map.D)?parseFloat(map.D.replace(',','.')):parseInt(map.D,10)/100) : 0;
      const iva   = map.E ? parseFloat(map.E.replace(/[^0-9.,]/g,'').replace(',','.'))||0 : 0;
      return {
        pais: map.A||'PT',
        nif_emitente:(map.B||'').replace(/^PT/i,''),
        data: map.C||'',
        total:isNaN(total)?0:total,
        iva:isNaN(iva)?0:iva,
        outros:map.F||'',
        timestamp:new Date().toISOString(),
        qr_original:raw
      };
    }

    /* ---------------------------- Helpers --------------------------------- */
    const $ = s=>document.querySelector(s);
    const notify=(m,t)=>{const n=document.createElement('div');n.className=`notification ${t}`;n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.classList.add('show'),20);setTimeout(()=>{n.classList.remove('show');setTimeout(()=>n.remove(),300);},3000);};
    const ok = m=>notify(m,'success'); const err=m=>notify(m,'error');
    const fmt=d=>new Date(d).toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});

    /* ---------------------- Firestore + UI  ------------------------------ */
    async function guardarFatura(inv){
      await addDoc(collection(db,'faturas'),inv);
      await stats(); await recentes(); ok('Fatura guardada!');
    }
    async function stats(){
      const snap=await getDocs(collection(db,'faturas'));
      const total=snap.docs.reduce((s,d)=>s+(d.data().total||0),0);
      $('#total-faturas').textContent=snap.size;
      $('#total-valor').textContent=total.toFixed(2);
    }
    async function recentes(){
      const q=query(collection(db,'faturas'),orderBy('timestamp','desc'),limit(5));
      const s=await getDocs(q);const c=$('#recent-invoices-list');
      c.innerHTML=s.empty?'<p class="no-invoices">Nenhuma fatura</p>':
        s.docs.map(d=>{const r=d.data();return`
          <div class="invoice-card">
            <div class="invoice-header"><span class="invoice-amount">€${r.total.toFixed(2)}</span><span class="invoice-date">${fmt(r.timestamp)}</span></div>
            <div class="invoice-details"><p><strong>NIF:</strong> ${r.nif_emitente||'—'}</p><p><strong>IVA:</strong> €${r.iva.toFixed(2)}</p></div>
          </div>`;}).join('');
    }

    /* --------------------------- Scanner ---------------------------------- */
    function startScanner(constraints={}){
      if(scanner){ scanner.clear(); }
      scanner = new Html5QrcodeScanner("reader",{fps:10,qrbox:{width:250,height:250},aspectRatio:1,videoConstraints:constraints},false);
      scanner.render(txt=>{
        if(isProcessing) return;
        isProcessing=true;
        pendingInv=parseFaturaQR(txt);
        preview(pendingInv);
        scanner.clear();
        $('#scan-status').textContent='QR lido — confirme';
      });
      $('#scan-status').textContent='Pronto para escanear';
    }

    /* -------------------------- Renderização ----------------------------- */
    function preview(inv){
      $('#output').innerHTML=`
        <div class="preview-data">
          <h3>Pré-visualização</h3>
          <ul class="data-grid">
            <li><b>Total:</b> €${inv.total.toFixed(2)}</li>
            <li><b>IVA:</b> €${inv.iva.toFixed(2)}</li>
            <li><b>NIF:</b> ${inv.nif_emitente||'—'}</li>
            <li><b>Data:</b> ${inv.data||'—'}</li>
          </ul>
          <div class="preview-actions mt-4 flex gap-3">
            <button id="canc" class="btn btn-secondary">Cancelar</button>
            <button id="save" class="btn btn-primary">Guardar</button>
          </div>
        </div>`;
      $('#canc').onclick=resetOutput;
      $('#save').onclick=async()=>{
        await guardarFatura(inv); resetOutput(); display(inv);
      };
    }
    function display(inv){
      $('#output').innerHTML=`
        <div class="scanned-data"><h3>✅ Fatura Guardada</h3>
        <p>Total €${inv.total.toFixed(2)} | NIF ${inv.nif_emitente||'—'} | ${inv.data||'—'}</p></div>`;
    }
    function resetOutput(){
      pendingInv=null;isProcessing=false;
      $('#output').innerHTML='<div style="text-align:center;color:#666;padding:40px"><h3>🔍 Aguardando leitura…</h3></div>';
      startScanner();
    }

    /* ----------------------------- UI Eventos ---------------------------- */
    window.addEventListener('DOMContentLoaded',async ()=>{
      startScanner(); await stats(); await recentes();

      const toggle=$('#toggle-scanner');
      toggle.addEventListener('click',()=>{
        if(paused){ startScanner(); toggle.textContent='⏸️ Pausar Scanner'; }
        else      { scanner.clear(); toggle.textContent='▶️ Retomar Scanner'; }
        paused=!paused;
      });

      $('#switch-camera').addEventListener('click', async ()=>{
        const devs=await Html5Qrcode.getCameras();
        if(devs.length<2){ err('Só uma câmara'); return; }
        cameraIndex=(cameraIndex+1)%devs.length;
        startScanner({deviceId:{exact:devs[cameraIndex].id}});
        ok('Câmara trocada!');
      });

      $('#clear-results').addEventListener('click', resetOutput);
    });
  </script>
  <link rel="stylesheet" href="invoices-reader.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>💳 Wallet 360</h1>
      <p>Gestor inteligente de faturas com QR Code</p>
    </div>

    <div class="main-content">
      <div class="scanner-section">
        <div class="scan-area">
          <h2>📱 Scanner QR</h2>
          <div id="reader"></div>
          <div id="scan-status" class="scan-status">Inicializando scanner...</div>
          <div class="scanner-controls">
            <button id="toggle-scanner" class="btn btn-primary">⏸️ Pausar Scanner</button>
            <button id="switch-camera" class="btn btn-secondary">🔄 Trocar Câmera</button>
          </div>
        </div>
      </div>

      <div class="stats-section">
        <h2>📊 Estatísticas</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-faturas">0</div>
            <div class="stat-label">Total Faturas</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">€<span id="total-valor">0.00</span></div>
            <div class="stat-label">Valor Total</div>
          </div>
        </div>
        <div class="stats-actions">
          <button id="refresh-stats" class="btn btn-outline">🔄 Atualizar</button>
          <button id="export-data" class="btn btn-outline">📊 Exportar</button>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="scan-results">📄 Última Fatura</button>
        <button class="tab-button" data-tab="recent-invoices">📋 Faturas Recentes</button>
      </div>
      
      <div id="scan-results" class="tab-content active">
        <div id="output">
          <div style="text-align: center; color: #666; padding: 40px;">
            <h3>🔍 Aguardando leitura...</h3>
            <p>Aponte a câmera para o QR code da fatura</p>
          </div>
        </div>
        <div class="scan-actions">
          <button id="clear-results" class="btn btn-secondary">🗑️ Limpar Resultados</button>
          <button id="manual-input" class="btn btn-primary">✍️ Inserir Manual</button>
        </div>
      </div>
      
      <div id="recent-invoices" class="tab-content">
        <div class="invoices-header">
          <h3>📋 Faturas Recentes</h3>
          <div class="invoices-actions">
            <button id="refresh-invoices" class="btn btn-small btn-outline">🔄 Atualizar</button>
            <button id="delete-all" class="btn btn-small btn-danger">🗑️ Limpar Tudo</button>
          </div>
        </div>
        <div id="recent-invoices-list">
          <p class="no-invoices">Carregando faturas...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
  </div>
</body>
</html>
