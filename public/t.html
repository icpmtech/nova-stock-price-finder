<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallet360 – Dashboard</title>

  <!-- Ícones / cores -->
  <meta name="theme-color" content="#6366f1" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <!-- Fontes + Tailwind + Plotly -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          colors: {
            primary: {
              50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
              400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
              800: '#075985', 900: '#0c4a6e'
            },
            success: {
              50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
              400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
              800: '#166534', 900: '#14532d'
            },
            warning: {
              50: '#fefce8', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d',
              400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309',
              800: '#92400e', 900: '#78350f'
            },
            danger: {
              50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5',
              400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c',
              800: '#991b1b', 900: '#7f1d1d'
            },
            gray: {
              50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db',
              400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151',
              800: '#1f2937', 900: '#111827'
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
            'slide-down': 'slideDown 0.4s ease-out',
            'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-subtle': 'bounceSubtle 0.6s ease-in-out',
            'scale-in': 'scaleIn 0.3s ease-out',
            'shimmer': 'shimmer 2s linear infinite'
          },
          backdropBlur: { xs: '2px' },
          boxShadow: {
            glow: '0 0 20px rgba(99,102,241,0.3)',
            card: '0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)',
            'card-hover': '0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)'
          }
        }
      }
    }
  </script>

  <style>
    @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
    @keyframes slideUp { from { transform:translateY(20px); opacity:0 } to { transform:translateY(0); opacity:1 } }
    @keyframes slideDown { from { transform:translateY(-20px); opacity:0 } to { transform:translateY(0); opacity:1 } }
    @keyframes bounceSubtle { 0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)} }
    @keyframes scaleIn { from{transform:scale(.95); opacity:0} to{transform:scale(1); opacity:1} }
    @keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

    .loading-spinner{border:2px solid #f3f4f6;border-top:2px solid #6366f1;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite}
    .skeleton{background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 50%,#f3f4f6 75%);background-size:200% 100%;animation:shimmer 2s infinite;border-radius:.5rem}
    .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .glass-effect{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
    .profit-positive{color:#22c55e}.profit-negative{color:#ef4444}.profit-neutral{color:#6b7280}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
    ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:#f1f5f9;border-radius:4px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#94a3b8}
  </style>
</head>

<body class="font-inter bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen text-gray-800 antialiased scroll-smooth">

  <!-- Header -->
  <header class="sticky top-0 z-50 glass-effect border-b border-white/20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center text-white font-bold">W3</div>
          <div>
            <h1 class="text-xl font-bold text-white">Wallet360</h1>
            <p class="text-sm text-white/70">Dashboard de Investimentos</p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="hidden sm:flex items-center space-x-2 text-white/80">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span id="connectionStatus" class="text-sm">Conectado</span>
          </div>
          <div class="text-right hidden sm:block">
            <span id="userName" class="text-white font-medium text-sm block"></span>
            <span class="text-xs text-white/70">Investidor</span>
          </div>
          <button id="signOutBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm shadow-lg">Sair</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="glass-effect p-8 rounded-2xl text-center max-w-sm mx-4">
      <div class="loading-spinner mx-auto mb-4"></div>
      <p class="text-white font-medium">Carregando dados...</p>
    </div>
  </div>

  <!-- Floating Button -->
  <button id="openFormBtn" class="fixed bottom-8 right-8 w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-full shadow-glow flex items-center justify-center z-40 transition-all duration-300 hover:scale-110 group">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 transition-transform group-hover:rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
  </button>
  <div id="drawerOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-40"></div>

  <!-- Drawer -->
  <aside id="formDrawer" class="fixed top-0 right-0 transform translate-x-full w-full sm:w-96 bg-white h-full shadow-2xl z-50 transition-transform overflow-y-auto">
    <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
      <h2 id="drawerTitle" class="text-xl font-semibold">Nova Transação</h2>
      <button id="closeFormBtn" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-6">
      <form id="transactionForm" class="space-y-6">
        <input type="hidden" id="transactionId">
        <div>
          <label class="block text-sm font-medium mb-2">Símbolo da Ação</label>
          <input id="symbol" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" placeholder="Ex: AAPL" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Tipo de Operação</label>
          <select id="operation" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" required>
            <option value="">Selecione</option>
            <option value="buy">🟢 Compra</option>
            <option value="sell">🔴 Venda</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Quantidade</label>
            <input id="amount" type="number" min="0" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Preço (€)</label>
            <input id="price" type="number" min="0" step="0.0001" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" required>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Taxa (€)</label>
            <input id="fee" type="number" min="0" step="0.0001" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Data</label>
            <input id="date" type="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-indigo-500" required>
          </div>
        </div>
        <div class="flex space-x-3 pt-4">
          <button id="submitBtn" class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-lg shadow-lg flex items-center justify-center disabled:opacity-50">
            <span id="submitText">Guardar Transação</span>
            <div id="submitSpinner" class="loading-spinner hidden ml-2"></div>
          </button>
          <button id="cancelEdit" type="button" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg hidden">Cancelar</button>
        </div>
      </form>
    </div>
  </aside>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <!-- Hero Stats -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="glass-effect rounded-2xl p-6 text-white card-hover">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="opacity-80 text-sm">Total de Transações</h3>
            <p id="totalTransactions" class="text-3xl font-bold mt-2">0</p>
          </div>
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm6 0a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v14z"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="glass-effect rounded-2xl p-6 text-white card-hover">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="opacity-80 text-sm">Lucro Total</h3>
            <p id="totalProfit" class="text-3xl font-bold mt-2">€0.00</p>
          </div>
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="glass-effect rounded-2xl p-6 text-white card-hover">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="opacity-80 text-sm">Última Atualização</h3>
            <p id="lastUpdate" class="text-sm font-medium mt-2">--</p>
          </div>
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="glass-effect rounded-2xl p-6 text-white card-hover">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="opacity-80 text-sm">Tempo desde atualização</h3>
            <p id="updateTimer" class="text-2xl font-bold mt-2">--</p>
          </div>
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </div>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section class="bg-white rounded-2xl shadow-card">
      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold">Transações</h2>
          <p class="text-indigo-100">Gerir as suas operações de investimento</p>
        </div>
        <button id="refreshBtn" class="px-6 py-3 bg-white/20 hover:bg-white/30 rounded-lg flex items-center space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span id="refreshText">Atualizar</span>
          <div id="refreshSpinner" class="loading-spinner hidden"></div>
        </button>
      </div>
      <!-- Desktop table -->
      <div class="hidden lg:block overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Símbolo</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Operação</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Quantidade</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Preço</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Preço Atual</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Lucro</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Taxa</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Ações</th>
            </tr>
          </thead>
          <tbody id="transactionTbody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <!-- Mobile list -->
      <div id="mobileList" class="lg:hidden p-4 space-y-4"></div>

      <div id="emptyState" class="text-center py-16 hidden">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm6 0a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2a2 2 0 00-2 2v14z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">Nenhuma transação encontrada</h3>
        <p class="text-gray-500 mb-8 max-w-md mx-auto">Comece a adicionar as suas transações para acompanhar o desempenho.</p>
        <button onclick="document.getElementById('openFormBtn').click()" class="px-8 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow-lg">Adicionar primeira transação</button>
      </div>
    </section>

    <!-- Chart -->
    <section class="bg-white rounded-2xl shadow-card p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold">Análise de Lucros</h2>
          <p class="text-gray-600">Evolução dos seus resultados</p>
        </div>
        <div class="flex items-center space-x-2 text-sm text-gray-500">
          <div class="w-2 h-2 bg-indigo-500 rounded-full"></div>
          <span>Lucro/Prejuízo</span>
        </div>
      </div>
      <div id="profitChart" class="w-full h-96"></div>
    </section>
  </main>

  <div id="toastContainer" class="fixed top-24 right-4 z-50 space-y-3"></div>

  <!-- Delete Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl animate-scale-in">
      <div class="text-center">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-4">Confirmar Exclusão</h3>
        <p class="text-gray-600 mb-8">Tem certeza de que deseja eliminar esta transação? Esta ação não pode ser desfeita.</p>
        <div class="flex justify-center space-x-4">
          <button id="confirmDeleteBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg">Eliminar</button>
          <button id="cancelDeleteBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script type="module">
    const API = 'https://wallet360.vercel.app/api/transactions';
    const state = { transactions: [], editingId: null, lastFetch: null };

    /* Helper */
    const fmt = n => Number(n).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    /* Toast */
    const toast = (msg, type='success') => {
      const el = document.createElement('div');
      el.className = \`px-4 py-3 rounded-lg text-white shadow-lg bg-\${type==='error'?'red':'green'}-600 animate-slide-down\`;
      el.textContent = msg;
      document.getElementById('toastContainer').appendChild(el);
      setTimeout(()=>el.remove(), 4000);
    };

    /* DOM refs */
    const totalTxEl = document.getElementById('totalTransactions');
    const totalProfitEl = document.getElementById('totalProfit');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const timerEl = document.getElementById('updateTimer');
    const tbody = document.getElementById('transactionTbody');
    const mobList = document.getElementById('mobileList');
    const empty = document.getElementById('emptyState');

    const drawer = document.getElementById('formDrawer');
    const drawerOverlay = document.getElementById('drawerOverlay');
    const openFormBtn = document.getElementById('openFormBtn');
    const closeFormBtn = document.getElementById('closeFormBtn');

    const form = document.getElementById('transactionForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const cancelEdit = document.getElementById('cancelEdit');
    const drawerTitle = document.getElementById('drawerTitle');

    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    const refreshBtn = document.getElementById('refreshBtn');
    const refreshText = document.getElementById('refreshText');
    const refreshSpinner = document.getElementById('refreshSpinner');
    const loadingOverlay = document.getElementById('loadingOverlay');

    /* Inputs */
    const idInput = document.getElementById('transactionId');
    const symInput = document.getElementById('symbol');
    const opInput = document.getElementById('operation');
    const qtyInput = document.getElementById('amount');
    const priceInput = document.getElementById('price');
    const feeInput = document.getElementById('fee');
    const dateInput = document.getElementById('date');

    /* --------------------------------------------- */
    /* Render */
    function profitCalc(tx) {
      const current = tx.currentPrice ?? tx.price;
      return tx.operation === 'buy'
        ? (current - tx.price) * tx.amount - tx.fee
        : (tx.price - current) * tx.amount - tx.fee;
    }

    function render() {
      totalTxEl.textContent = state.transactions.length;
      const totalProfit = state.transactions.reduce((a, t) => a + t.profit, 0);
      totalProfitEl.textContent = '€' + fmt(totalProfit);
      totalProfitEl.className = totalProfit > 0 ? 'profit-positive text-3xl font-bold mt-2'
                              : totalProfit < 0 ? 'profit-negative text-3xl font-bold mt-2'
                              : 'profit-neutral text-3xl font-bold mt-2';
      lastUpdateEl.textContent = state.lastFetch ? new Date(state.lastFetch).toLocaleString('pt-PT') : '--';

      if (!state.transactions.length) {
        empty.classList.remove('hidden');
        tbody.innerHTML = mobList.innerHTML = '';
        Plotly.purge('profitChart');
        return;
      }
      empty.classList.add('hidden');

      /* Table */
      tbody.innerHTML = '';
      state.transactions.forEach(tx => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-6 py-4">${tx.symbol}</td>
          <td class="px-6 py-4">${tx.operation==='buy'?'Compra':'Venda'}</td>
          <td class="px-6 py-4">${fmt(tx.amount)}</td>
          <td class="px-6 py-4">€${fmt(tx.price)}</td>
          <td class="px-6 py-4">€${fmt(tx.currentPrice)}</td>
          <td class="px-6 py-4 ${tx.profit>0?'profit-positive':tx.profit<0?'profit-negative':'profit-neutral'}">€${fmt(tx.profit)}</td>
          <td class="px-6 py-4">€${fmt(tx.fee)}</td>
          <td class="px-6 py-4">${tx.date}</td>
          <td class="px-6 py-4 space-x-2">
            <button data-id="${tx.id}" class="editBtn text-indigo-600 hover:underline">Editar</button>
            <button data-id="${tx.id}" class="delBtn text-red-600 hover:underline">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });

      /* Mobile */
      mobList.innerHTML = '';
      state.transactions.forEach(tx => {
        const card=document.createElement('div');
        card.className='glass-effect p-4 rounded-xl';
        card.innerHTML=`
          <div class="flex justify-between mb-2">
            <h4 class="font-semibold">${tx.symbol}</h4>
            <span class="${tx.operation==='buy'?'profit-positive':'profit-negative'} text-sm">${tx.operation==='buy'?'Compra':'Venda'}</span>
          </div>
          <div class="text-sm text-gray-200 space-y-1">
            <p>Qtde: ${fmt(tx.amount)}</p>
            <p>Preço: €${fmt(tx.price)}</p>
            <p>Atual: €${fmt(tx.currentPrice)}</p>
            <p>Lucro: <span class="${tx.profit>0?'profit-positive':tx.profit<0?'profit-negative':'profit-neutral'}">€${fmt(tx.profit)}</span></p>
            <p>Taxa: €${fmt(tx.fee)}</p>
            <p>Data: ${tx.date}</p>
          </div>
          <div class="flex justify-end mt-3 space-x-3">
            <button data-id="${tx.id}" class="editBtn text-indigo-200 underline">Editar</button>
            <button data-id="${tx.id}" class="delBtn text-red-300 underline">Eliminar</button>
          </div>`;
        mobList.appendChild(card);
      });

      /* Chart */
      const byDate={};
      state.transactions.forEach(t=>{byDate[t.date]=(byDate[t.date]||0)+t.profit});
      const dates=Object.keys(byDate).sort();
      Plotly.newPlot('profitChart',[{x:dates,y:dates.map(d=>byDate[d]),type:'bar',marker:{color:'#6366f1'}}],
        {margin:{t:20},paper_bgcolor:'white',plot_bgcolor:'white'},{displayModeBar:false});
    }

    /* --------------------------------------------- */
    async function fetchData() {
      loadingOverlay.classList.remove('hidden');
      try {
        const res = await fetch(API);
        const raw = await res.json();
        state.transactions = raw.map(tx => {
          const current = tx.currentPrice ?? (tx.price*(1+(Math.random()-0.5)*0.1));
          return {...tx,currentPrice:current,profit:profitCalc({...tx,currentPrice:current})};
        });
        state.lastFetch=Date.now();
        render();
      } catch(e){toast('Erro ao carregar','error');console.error(e)}
      loadingOverlay.classList.add('hidden');
    }

    async function upsert(tx){
      submitSpinner.classList.remove('hidden');
      submitText.textContent=state.editingId?'A guardar…':'A adicionar…';
      submitBtn.disabled=true;
      try{
        const res = await fetch(state.editingId?`${API}/${state.editingId}`:API,{
          method: state.editingId?'PUT':'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(tx)
        });
        if(!res.ok) throw new Error();
        toast(state.editingId?'Atualizado':'Adicionado');
        closeDrawer();
        await fetchData();
      }catch(e){toast('Erro','error');console.error(e)}
      submitSpinner.classList.add('hidden');
      submitText.textContent='Guardar Transação';
      submitBtn.disabled=false;
    }

    async function remove(id){
      try{
        const res=await fetch(`${API}/${id}`,{method:'DELETE'});
        if(!res.ok) throw new Error();
        toast('Eliminado');await fetchData();
      }catch(e){toast('Erro','error');console.error(e)}
    }

    /* Drawer */
    function openDrawer(){drawer.classList.remove('translate-x-full');drawerOverlay.classList.remove('hidden')}
    function closeDrawer(){drawer.classList.add('translate-x-full');drawerOverlay.classList.add('hidden');form.reset();cancelEdit.classList.add('hidden');drawerTitle.textContent='Nova Transação';state.editingId=null}

    openFormBtn.onclick=openDrawer;closeFormBtn.onclick=closeDrawer;drawerOverlay.onclick=closeDrawer;
    form.onsubmit=e=>{
      e.preventDefault();
      const tx={symbol:symInput.value.toUpperCase(),operation:opInput.value,amount:+qtyInput.value,price:+priceInput.value,fee:+feeInput.value,date:dateInput.value};
      upsert(tx);
    };
    cancelEdit.onclick=closeDrawer;

    document.addEventListener('click',e=>{
      if(e.target.classList.contains('editBtn')){
        const tx=state.transactions.find(t=>t.id==e.target.dataset.id);
        if(!tx)return;
        state.editingId=tx.id;
        drawerTitle.textContent='Editar Transação';
        cancelEdit.classList.remove('hidden');
        idInput.value=tx.id;symInput.value=tx.symbol;opInput.value=tx.operation;qtyInput.value=tx.amount;priceInput.value=tx.price;feeInput.value=tx.fee;dateInput.value=tx.date;
        openDrawer();
      }
      if(e.target.classList.contains('delBtn')){
        deleteModal.classList.remove('hidden');
        confirmDeleteBtn.onclick=()=>{deleteModal.classList.add('hidden');remove(e.target.dataset.id)};
        cancelDeleteBtn.onclick=()=>deleteModal.classList.add('hidden');
      }
    });

    refreshBtn.onclick=async()=>{
      refreshSpinner.classList.remove('hidden');refreshText.textContent='Atualizando…';refreshBtn.disabled=true;
      await fetchData();
      refreshSpinner.classList.add('hidden');refreshText.textContent='Atualizar';refreshBtn.disabled=false;
    };

    fetchData();
  </script>
</body>
</html>
